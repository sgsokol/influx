
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>txt2ftbl &#8212; influx_si 6.0 documentation</title>
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">influx_si 6.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for txt2ftbl</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Transform a series of TXT and TSV files into FTBL file.</span>

<span class="sd">Copyright 2021, INRAE, INSA, CNRS</span>
<span class="sd">Author: Serguei Sokol (sokol at insa-toulouse dot fr)</span>
<span class="sd">License: Gnu Public License (GPL) v2 http://www.gnu.org/licenses/gpl.html</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pa</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">stat</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">datetime</span> <span class="k">as</span> <span class="nn">dt</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">linalg</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">diag</span>
<span class="n">vsadd</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">defchararray</span><span class="o">.</span><span class="n">add</span> <span class="c1"># vector string add</span>
<span class="kn">import</span> <span class="nn">influx_si</span>
<span class="kn">from</span> <span class="nn">C13_ftbl</span> <span class="kn">import</span> <span class="n">formula2dict</span>

<span class="n">version</span><span class="o">=</span><span class="s2">&quot;1.0&quot;</span>
<span class="c1">#me=os.path.basename(sys.argv[0] or &quot;txt2ftbl&quot;)</span>
<span class="n">me</span><span class="o">=</span><span class="s2">&quot;txt2ftbl&quot;</span>
<span class="n">LOCAL_TIMEZONE</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">astimezone</span><span class="p">()</span><span class="o">.</span><span class="n">tzinfo</span>
<span class="n">invcomp</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;&gt;=&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;=&quot;</span><span class="p">,</span> <span class="s2">&quot;=&gt;&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;=&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;=&quot;</span><span class="p">:</span> <span class="s2">&quot;&gt;=&quot;</span><span class="p">,</span> <span class="s2">&quot;=&lt;&quot;</span><span class="p">:</span> <span class="s2">&quot;&gt;=&quot;</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">natural_sort_key</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">_re</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\d+)&#39;</span><span class="p">)):</span>
    <span class="c1"># last 2 fields are inverted for sorting</span>
    <span class="k">return</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">t</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">li</span> <span class="ow">in</span> <span class="p">(</span><span class="n">_re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">s</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">li</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">li</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">li</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>
<span class="k">def</span> <span class="nf">plain_natural_key</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">_re</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\d+)&#39;</span><span class="p">)):</span>
    <span class="k">return</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">t</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">li</span> <span class="ow">in</span> <span class="p">(</span><span class="n">_re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">s</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">li</span><span class="p">)]</span>
<div class="viewcode-block" id="dtstamp"><a class="viewcode-back" href="../progdoc.html#txt2ftbl.dtstamp">[docs]</a><span class="k">def</span> <span class="nf">dtstamp</span><span class="p">():</span>
    <span class="s2">&quot;formatted date-time stamp&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">LOCAL_TIMEZONE</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S %Z %z&#39;</span><span class="p">))</span></div>
<span class="k">def</span> <span class="nf">werr</span><span class="p">(</span><span class="n">mes</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">me</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">mes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">warn</span><span class="p">(</span><span class="n">mes</span><span class="p">):</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning! </span><span class="si">{</span><span class="n">me</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">mes</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">usage</span><span class="p">():</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="vm">__doc__</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="itvl2li"><a class="viewcode-back" href="../progdoc.html#txt2ftbl.itvl2li">[docs]</a><span class="k">def</span> <span class="nf">itvl2li</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
    <span class="s2">&quot;convert interval like &#39;2-5&#39;  to [&#39;2&#39;, &#39;3&#39;, &#39;4&#39;, &#39;5&#39;]&quot;</span>
    <span class="n">li</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">li</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">li</span><span class="p">[</span><span class="mi">0</span><span class="p">]))]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">li</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">li</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span></div>
<div class="viewcode-block" id="dsec2out"><a class="viewcode-back" href="../progdoc.html#txt2ftbl.dsec2out">[docs]</a><span class="k">def</span> <span class="nf">dsec2out</span><span class="p">(</span><span class="n">dsec</span><span class="p">,</span> <span class="n">fout</span><span class="p">):</span>
    <span class="s2">&quot;write lines from dsec to fout&quot;</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">li</span> <span class="ow">in</span> <span class="n">dsec</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">li</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="n">dsec2out</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">fout</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">item</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>
<div class="viewcode-block" id="tsv2df"><a class="viewcode-back" href="../progdoc.html#txt2ftbl.tsv2df">[docs]</a><span class="k">def</span> <span class="nf">tsv2df</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="n">skip_blank_lines</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">append_iline</span><span class="o">=</span><span class="s2">&quot;iline&quot;</span><span class="p">,</span> <span class="n">encodings</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">,</span> <span class="s2">&quot;windows-1250&quot;</span><span class="p">,</span> <span class="s2">&quot;windows-1252&quot;</span><span class="p">]):</span>
    <span class="s2">&quot;Read file &#39;f&#39; as TSV and return a DataFrame. Separator is &#39;sep&#39;, comment char is &#39;comment&#39;, blank lines are skept, header is in the first row, file line numbers are stored in a column &#39;line_nb&#39; if there is no a column with this name&quot;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="n">Path</span><span class="p">()):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">encodings</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">li</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">encodings</span><span class="p">):</span>
                    <span class="c1"># it was the last chance</span>
                    <span class="k">raise</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">li</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">readlines</span>
    <span class="n">rows</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
    <span class="n">irow</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">cnm</span><span class="o">=</span><span class="p">[]</span> <span class="c1"># col names</span>
    <span class="k">for</span> <span class="n">ili</span><span class="p">,</span><span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">li</span><span class="p">):</span>
        <span class="c1"># remove comments</span>
        <span class="k">if</span> <span class="n">comment</span><span class="p">:</span>
            <span class="n">row</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.*$&quot;</span><span class="o">%</span><span class="n">comment</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">skip_blank_lines</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">row</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cnm</span><span class="p">:</span>
            <span class="n">cnm</span><span class="o">=</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">)]</span>
            <span class="n">ncol</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">cnm</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">append_iline</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span><span class="o">==</span><span class="n">append_iline</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cnm</span><span class="p">):</span>
                    <span class="n">cnm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">append_iline</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">append_iline</span><span class="o">=</span><span class="kc">False</span>
            <span class="n">rows</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cnm</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="c1"># append rows</span>
        <span class="n">rli</span><span class="o">=</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rli</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ncol</span><span class="p">:</span>
            <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;tsv2df: wrong column number </span><span class="si">%d</span><span class="s2">, expected </span><span class="si">%d</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">: </span><span class="si">%d</span><span class="s2">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rli</span><span class="p">),</span> <span class="n">ncol</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ili</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">append_iline</span><span class="p">:</span>
            <span class="n">rli</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ili</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">rows</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">rli</span><span class="p">))</span>
    <span class="n">df</span><span class="o">=</span><span class="n">pa</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span><span class="n">cnm</span>
    <span class="k">return</span> <span class="n">df</span></div>
<div class="viewcode-block" id="try_ext"><a class="viewcode-back" href="../progdoc.html#txt2ftbl.try_ext">[docs]</a><span class="k">def</span> <span class="nf">try_ext</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">li</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;See if file &#39;f&#39; exists, if not try with extensions from &#39;li&#39;.</span>
<span class="sd">    The first found is returned as Path() otherwise an exception is raised.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">Path</span><span class="p">()),</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># check if we need to add an extension</span>
        <span class="n">pth</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pth</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">suf</span> <span class="ow">in</span> <span class="n">li</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">suf</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
                    <span class="n">suf</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="o">+</span><span class="n">suf</span>
                <span class="n">npth</span><span class="o">=</span><span class="n">pth</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="n">suf</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">npth</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                    <span class="k">return</span> <span class="n">npth</span>
                <span class="n">npth</span><span class="o">=</span><span class="n">pth</span><span class="o">.</span><span class="n">parent</span><span class="o">/</span><span class="p">(</span><span class="n">pth</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="n">suf</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">npth</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                    <span class="k">return</span> <span class="n">npth</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;try_ext: not found file &#39;</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">&#39; neither literal nor with extensions: &#39;&quot;</span><span class="o">+</span><span class="s2">&quot;&#39;, &#39;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">li</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pth</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;try_ext: unknown type of &#39;f&#39;. Expecting &#39;str&#39; or &#39;Path&#39;.&quot;</span><span class="p">)</span></div>
    

<div class="viewcode-block" id="txt_parse"><a class="viewcode-back" href="../progdoc.html#txt2ftbl.txt_parse">[docs]</a><span class="k">def</span> <span class="nf">txt_parse</span><span class="p">(</span><span class="n">ftxt</span><span class="p">,</span> <span class="n">re_metab</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(?:(?P&lt;coef&gt;[\d\.]*)\s+)?(?:(?P&lt;metab&gt;[^() \t\r]+)\s*)(?:\(\s*(?P&lt;carb&gt;[^()]*)\s*\))?\s*&quot;</span><span class="p">),</span>
        <span class="n">re_labpat</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^[./*\d\s]*(?P&lt;labpat&gt;[a-zA-Z]*)\s*$&quot;</span><span class="p">),</span> <span class="n">encodings</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="s2">&quot;windows-1250&quot;</span><span class="p">,</span> <span class="s2">&quot;windows-1252&quot;</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Parse txt file from fname which is in format:</span>
<span class="sd">### Glycolysis and OPP pathway</span>
<span class="sd">GLYC (abcdef) -&gt;  G6P (abcdef)</span>
<span class="sd">G6P (abcdef)  &lt;-&gt; F6P (abcdef)</span>
<span class="sd">i.e.</span>

<span class="sd">comment: # blabla</span>
<span class="sd">non reversible reaction: [reac: ][N1] metab1 [(carb1)] [... + [N_i] metab_i [(carb_i)]] -&gt; ...</span>
<span class="sd">where</span>
<span class="sd"> reac is an optional reaction name;</span>
<span class="sd"> N_i is optional stoechiometric coefficient</span>
<span class="sd"> metab_i is i-th metabolite name</span>
<span class="sd"> (carb_i) is optional 1-letter carbon names for carbon transition mapping</span>

<span class="sd">reversible reaction is represented by &quot;&lt;-&gt;&quot; sign</span>
<span class="sd">non reversible reaction is represented by &quot;-&gt;&quot; sign.</span>
<span class="sd">reaction with imposed sens of reaction (from left to right) is representd with double &quot;&gt;&gt;&quot;,</span>
<span class="sd">i.e. &quot;-&gt;&gt;&quot; for non reversible reaction or &quot;&lt;-&gt;&gt;&quot; for reversible reaction. This</span>
<span class="sd">reaction with imposed sens will have an inequality &quot;reac_name &gt;= 0&quot; in</span>
<span class="sd">FTBL/INEQUAITIES/NET section.</span>

<span class="sd">Retrun a list with following items:</span>
<span class="sd">- a list of carbon exchange reactions</span>
<span class="sd">- a list of non carbon echanging reactions</span>
<span class="sd">- a list of equalities net and xch</span>
<span class="sd">- a list of flux tuples (reac, rev, imposed_sens)</span>
<span class="sd">- a list of two lists: left and right metabolites [(metab, clen),]</span>
<span class="sd">- a carbon length dictionary {met: N}</span>

<span class="sd">the first item is a list of:</span>
<span class="sd">plain string == just a comments</span>
<span class="sd">list == reaction items: input, output: lists of tuples (metab, carb, coeff)</span>
<span class="sd">&quot;&quot;&quot;</span>
    <span class="n">res</span><span class="o">=</span><span class="p">[]</span> <span class="c1"># main result. Each item can be a plain str (== comment) or a 4-tuple: reac, reversible?, imposed_sens?, list of in-metabo-tuples, list of out-metabo-tuples</span>
    <span class="c1"># each metabo-tuple is (coef, metab, labeling-pattern)</span>
    
    <span class="n">eqs</span><span class="o">=</span><span class="p">[[],</span> <span class="p">[]]</span> <span class="c1"># lists (net &amp; xch) of equalities: tuple (value, formula)</span>
    <span class="n">ineqs</span><span class="o">=</span><span class="p">[[],</span> <span class="p">[]]</span> <span class="c1"># lists (net &amp; xch) of inequalities: tuple (value, comp_sign, formula)</span>
    <span class="n">fluxes</span><span class="o">=</span><span class="p">[]</span> <span class="c1"># list of tuples (nm_reac, rev)</span>
    <span class="n">resnotr</span><span class="o">=</span><span class="p">[]</span> <span class="c1"># list of reaction without tracer (like biomass)</span>
    <span class="n">dclen</span><span class="o">=</span><span class="p">{}</span>
    <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    
    <span class="n">open_here</span><span class="o">=</span><span class="kc">False</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ftxt</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="n">Path</span><span class="p">()):</span>
        <span class="n">open_here</span><span class="o">=</span><span class="kc">True</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">encodings</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fc</span><span class="o">=</span><span class="n">ftxt</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
                <span class="n">li</span><span class="o">=</span><span class="n">fc</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">encodings</span><span class="p">):</span>
                    <span class="c1"># it was the last chance</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tried following encodings but to no avail: </span><span class="si">{</span><span class="n">ecodings</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">raise</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>
        
        <span class="n">fname</span><span class="o">=</span><span class="n">ftxt</span><span class="o">.</span><span class="n">name</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fc</span><span class="o">=</span><span class="n">ftxt</span>
        <span class="n">li</span><span class="o">=</span><span class="n">fc</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">fname</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">ftxt</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
    <span class="n">m_left</span><span class="o">=</span><span class="p">{}</span> <span class="c1"># metab sources</span>
    <span class="n">m_right</span><span class="o">=</span><span class="p">{}</span> <span class="c1"># metab products</span>
    <span class="n">sto</span><span class="o">=</span><span class="p">{}</span> <span class="c1"># stoechiometric matrix dictionary {flux:{metab: coef}}}</span>
    <span class="n">mconn</span><span class="o">=</span><span class="p">[]</span> <span class="c1"># list of connected metabolite sets. Should be only one</span>
    <span class="n">ireac</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">ipath</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">iline</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">li</span><span class="p">:</span>
        <span class="n">iline</span><span class="o">=</span><span class="n">iline</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">l</span><span class="o">=</span><span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;#&quot;</span><span class="p">:</span>
            <span class="n">comment</span><span class="o">+=</span><span class="s2">&quot;//&quot;</span><span class="o">+</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">l</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;###&quot;</span><span class="p">:</span>
                <span class="n">ipath</span><span class="o">=</span><span class="n">ipath</span><span class="o">+</span><span class="p">(</span><span class="n">ireac</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">ireac</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">continue</span>
        <span class="c1"># parse reaction</span>
        <span class="n">ireac</span><span class="o">=</span><span class="n">ireac</span><span class="o">+</span><span class="mi">1</span>
        <span class="c1"># strip possible end-line comment</span>
        <span class="n">li</span><span class="o">=</span><span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">li</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">l</span><span class="o">=</span><span class="n">li</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">li</span><span class="o">=</span><span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">li</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">nm_reac</span><span class="o">=</span><span class="n">li</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">reac</span><span class="o">=</span><span class="n">li</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nm_reac</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ipath</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;.&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ireac</span><span class="p">)</span>
            <span class="n">reac</span><span class="o">=</span><span class="n">li</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">in_out</span><span class="o">=</span><span class="p">[</span><span class="n">side</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">side</span> <span class="ow">in</span> <span class="n">reac</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&gt;&quot;</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_out</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;txt_parse: bad syntax. No reaction detected in &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">iline</span><span class="p">))</span>
        <span class="c1"># True|False is for reversible or not, imposed_sens or not</span>
        <span class="n">rev</span><span class="o">=</span><span class="kc">False</span>
        <span class="n">imposed_sens</span><span class="o">=</span><span class="kc">False</span>
        <span class="k">if</span> <span class="n">in_out</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">:</span>
            <span class="n">in_out</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">in_out</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">imposed_sens</span><span class="o">=</span><span class="kc">True</span>
        <span class="k">if</span> <span class="n">in_out</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">:</span>
            <span class="n">in_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">in_out</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">rev</span><span class="o">=</span><span class="kc">True</span>
        <span class="c1"># parse metabo-tuples</span>
        <span class="c1"># we cannot just split by &quot;+&quot; because of possible scrambling patterns having &quot;+&quot; in them</span>
        <span class="n">lr</span><span class="o">=</span><span class="p">[[(</span><span class="n">c</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="p">[</span><span class="n">elab</span> <span class="k">for</span> <span class="n">lab</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">elab</span> <span class="ow">in</span> <span class="n">re_labpat</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">lab</span><span class="p">)])</span> <span class="k">for</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="ow">in</span> <span class="n">re_metab</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">io</span><span class="p">)</span> <span class="k">if</span> <span class="n">m</span> <span class="o">!=</span> <span class="s2">&quot;+&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">io</span> <span class="ow">in</span> <span class="n">in_out</span><span class="p">]</span>
        <span class="n">tr_reac</span><span class="o">=</span><span class="nb">len</span><span class="p">([</span><span class="mi">1</span> <span class="k">for</span> <span class="n">side</span> <span class="ow">in</span> <span class="n">lr</span> <span class="k">for</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="ow">in</span> <span class="n">side</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">and</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span> <span class="c1"># it exists carbon transition</span>
        <span class="c1">#import pdb; pdb.set_trace();</span>
        <span class="k">if</span> <span class="n">tr_reac</span><span class="p">:</span>
            <span class="c1"># gather carbon lengths</span>
            <span class="k">for</span> <span class="n">side</span> <span class="ow">in</span> <span class="n">lr</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="n">side</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">dclen</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">dclen</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                            <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;txt_parse: metabolite &#39;</span><span class="si">%s</span><span class="s2">&#39; has different label lengths </span><span class="si">%d</span><span class="s2"> and </span><span class="si">%d</span><span class="s2">. The last is in &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">dclen</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">fname</span><span class="p">,</span> <span class="n">iline</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dclen</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        
            <span class="p">[[[(</span><span class="n">c</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">]</span> <span class="p">]]</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">side</span> <span class="ow">in</span> <span class="n">lr</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="n">side</span><span class="p">):</span>
            <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;txt_parse: wrong format for labeling pattern in &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%d</span><span class="s2">.&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">iline</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tr_reac</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">comment</span><span class="p">:</span>
                <span class="n">resnotr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
                <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
            <span class="n">resnotr</span><span class="o">.</span><span class="n">append</span><span class="p">([(</span><span class="n">nm_reac</span><span class="p">,</span> <span class="n">rev</span><span class="p">,</span> <span class="n">imposed_sens</span><span class="p">)]</span><span class="o">+</span><span class="n">lr</span><span class="p">)</span>
            <span class="n">fluxes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">nm_reac</span><span class="p">,</span> <span class="n">rev</span><span class="p">,</span> <span class="n">imposed_sens</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">))</span>
            <span class="c1"># add a row to stoechiometric matrix</span>
            <span class="k">if</span> <span class="n">nm_reac</span> <span class="ow">in</span> <span class="n">sto</span><span class="p">:</span>
                <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;txt_parse: reaction name &#39;</span><span class="si">%s</span><span class="s2">&#39; was already used (&#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%d</span><span class="s2">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">nm_reac</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">iline</span><span class="p">))</span>
            <span class="n">d</span><span class="o">=</span><span class="p">{}</span>
            <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="n">m</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span> <span class="k">else</span> <span class="mf">1.</span><span class="p">)</span><span class="o">+</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mf">0.</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="n">lr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="n">m</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span> <span class="k">else</span> <span class="mf">1.</span><span class="p">)</span><span class="o">+</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mf">0.</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="n">lr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">sto</span><span class="p">[</span><span class="n">nm_reac</span><span class="p">]</span><span class="o">=</span><span class="n">d</span>
            <span class="c1"># get m_left and m_right metab dicts</span>
            <span class="n">es</span><span class="o">=</span><span class="nb">dict</span><span class="p">((</span><span class="n">m</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="n">lr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">ps</span><span class="o">=</span><span class="nb">dict</span><span class="p">((</span><span class="n">m</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="n">lr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">rev</span><span class="p">:</span>
                <span class="n">es</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ps</span><span class="p">)</span>
                <span class="n">ps</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">es</span><span class="p">)</span>
            <span class="n">m_left</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="n">m</span><span class="p">,</span><span class="n">clen</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">clen</span> <span class="ow">in</span> <span class="n">es</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">m</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">m_left</span><span class="p">)</span>
            <span class="n">m_right</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="n">m</span><span class="p">,</span><span class="n">clen</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">clen</span> <span class="ow">in</span> <span class="n">ps</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">m</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">m_right</span><span class="p">)</span>
            <span class="k">continue</span>
        
        <span class="c1"># get position and length of scrumbles then make twin reactions 1,2,... with equalities</span>
        <span class="n">i_n_scr</span><span class="o">=</span><span class="p">[[(</span><span class="n">i</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span><span class="p">,(</span><span class="n">c</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">side</span><span class="p">)]</span> <span class="k">for</span> <span class="n">side</span> <span class="ow">in</span> <span class="n">lr</span><span class="p">]</span>
        <span class="c1"># prepare nested loops, one per scrumble</span>
        <span class="n">ilr</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">i_n_scr</span><span class="p">]</span>
        <span class="n">nlr</span><span class="o">=</span><span class="p">[[</span><span class="n">n</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">n</span> <span class="ow">in</span> <span class="n">it</span><span class="p">]</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">i_n_scr</span><span class="p">]</span>
        <span class="n">lrs</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">loop</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;for ilr[</span><span class="si">%(ilr)d</span><span class="s2">][</span><span class="si">%(isc)d</span><span class="s2">] in range(</span><span class="si">%(nsc)d</span><span class="s2">):&quot;</span><span class="o">%</span><span class="p">{</span><span class="s2">&quot;ilr&quot;</span><span class="p">:</span> <span class="n">il</span><span class="p">,</span> <span class="s2">&quot;isc&quot;</span><span class="p">:</span> <span class="n">isc</span><span class="p">,</span> <span class="s2">&quot;nsc&quot;</span><span class="p">:</span> <span class="n">nsc</span><span class="p">}</span> <span class="k">for</span> <span class="n">il</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">isc</span><span class="p">,</span><span class="n">nsc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nlr</span><span class="p">[</span><span class="n">il</span><span class="p">])</span> <span class="k">if</span> <span class="n">nsc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">code</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">it</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">it</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">loop</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">loop</span><span class="p">:</span>
            <span class="n">ire</span><span class="o">=</span><span class="mi">0</span>
            <span class="n">code</span><span class="o">+=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;lrs.append([[(c,m,(t[0] if (len(t) == 1) else t[ilr[isi][i]])) for (i, (c,m,t)) in enumerate(side)] for isi, side in enumerate(lr)])&quot;</span>
            <span class="n">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="nb">locals</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lrs</span><span class="o">=</span><span class="p">[[[(</span><span class="n">c</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="n">side</span><span class="p">]</span> <span class="k">for</span> <span class="n">side</span> <span class="ow">in</span> <span class="n">lr</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">ilr</span><span class="p">,</span> <span class="n">lr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lrs</span><span class="p">):</span>
            <span class="n">nm_r</span><span class="o">=</span><span class="n">nm_reac</span><span class="o">+</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ilr</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lrs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="c1"># add a row to stoechimetric matrix</span>
            <span class="k">if</span> <span class="n">nm_r</span> <span class="ow">in</span> <span class="n">sto</span><span class="p">:</span>
                <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;txt_parse: reaction name &#39;</span><span class="si">%s</span><span class="s2">&#39; was already used (&#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%d</span><span class="s2">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">nm_r</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">iline</span><span class="p">))</span>
            <span class="n">d</span><span class="o">=</span><span class="p">{}</span>
            <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="n">m</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span> <span class="k">else</span> <span class="mf">1.</span><span class="p">)</span><span class="o">+</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mf">0.</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="n">lr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="n">m</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span> <span class="k">else</span> <span class="mf">1.</span><span class="p">)</span><span class="o">+</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mf">0.</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="n">lr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">sto</span><span class="p">[</span><span class="n">nm_r</span><span class="p">]</span><span class="o">=</span><span class="n">d</span>
            <span class="c1"># get m_left and m_right metab dicts</span>
            <span class="n">es</span><span class="o">=</span><span class="nb">dict</span><span class="p">((</span><span class="n">m</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="n">lr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">ps</span><span class="o">=</span><span class="nb">dict</span><span class="p">((</span><span class="n">m</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="n">lr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">rev</span><span class="p">:</span>
                <span class="n">es</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ps</span><span class="p">)</span>
                <span class="n">ps</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">es</span><span class="p">)</span>
            <span class="c1"># update connected metabolite sets</span>
            <span class="n">ise</span><span class="o">=</span><span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mconn</span><span class="p">)</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">m</span> <span class="ow">in</span> <span class="n">s</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">es</span><span class="p">)]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ise</span><span class="p">:</span>
                <span class="n">mconn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">set</span><span class="p">())</span>
                <span class="n">ise</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">mconn</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ise</span><span class="o">=</span><span class="n">ise</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">mconn</span><span class="p">[</span><span class="n">ise</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">es</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">mconn</span><span class="p">[</span><span class="n">ise</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ps</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">m_left</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="n">m</span><span class="p">,</span><span class="n">clen</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">clen</span> <span class="ow">in</span> <span class="n">es</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">m</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">m_left</span><span class="p">)</span>
            <span class="n">m_right</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="n">m</span><span class="p">,</span><span class="n">clen</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">clen</span> <span class="ow">in</span> <span class="n">ps</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">m</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">m_right</span><span class="p">)</span>
            <span class="n">rgr</span><span class="o">=</span><span class="p">[]</span> <span class="c1"># reaction group (for possible long reactions)</span>
            <span class="n">r</span><span class="o">=</span><span class="p">[(</span><span class="n">nm_r</span><span class="p">,</span> <span class="n">rev</span><span class="p">,</span> <span class="n">imposed_sens</span><span class="p">),</span> <span class="p">[],</span> <span class="p">[]]</span> <span class="c1"># place for elementary reaction (no more than 2 metabs on each side)</span>
            <span class="n">fluxes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">nm_r</span><span class="p">,</span> <span class="n">rev</span><span class="p">,</span> <span class="n">imposed_sens</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span> <span class="k">if</span> <span class="n">ilr</span> <span class="k">else</span> <span class="s2">&quot;F&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">ilr</span><span class="p">:</span>
                <span class="n">teq</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> - </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">nm_reac</span><span class="o">+</span><span class="s2">&quot;_1&quot;</span><span class="p">,</span> <span class="n">nm_r</span><span class="p">))</span>
                <span class="n">eqs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">teq</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">rev</span><span class="p">:</span>
                    <span class="n">eqs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">teq</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ilr</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">imposed_sens</span><span class="p">:</span>
                <span class="n">ineqs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;&lt;=&quot;</span><span class="p">,</span> <span class="n">nm_r</span><span class="p">))</span>
            <span class="c1"># add sto row</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">lr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">lr</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="c1"># split this reaction in many: max two metabolites on each side</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lr</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lr</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">lr</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
                    <span class="c1"># we have to split here</span>
                    <span class="n">rgr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">[:])</span>
                    <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
                    <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">rgr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">[:])</span> <span class="c1"># final flush</span>
            <span class="k">if</span> <span class="n">comment</span><span class="p">:</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
                <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
            <span class="n">res</span><span class="o">+=</span><span class="n">rgr</span>
        
    <span class="k">if</span> <span class="n">open_here</span><span class="p">:</span>
        <span class="n">fc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="c1"># collapse rightmost connected metab set</span>
    <span class="n">rmc</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mconn</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rmc</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">mconn</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mconn</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">mconn</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">mconn</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">del</span><span class="p">(</span><span class="n">mconn</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">break</span>
            
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mconn</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">mconn</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">mconn</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;txt_parse: detected </span><span class="si">%d</span><span class="s2"> disconnected sub-networks in &#39;</span><span class="si">%s</span><span class="s2">&#39;:</span><span class="se">\n\t</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mconn</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;: &quot;</span><span class="o">+</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mconn</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))))</span>
    <span class="c1">#import pdb; pdb.set_trace()</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">res</span><span class="p">,</span> <span class="n">resnotr</span><span class="p">,</span> <span class="n">eqs</span><span class="p">,</span> <span class="n">ineqs</span><span class="p">,</span> <span class="n">fluxes</span><span class="p">,</span> <span class="p">[</span><span class="n">m_left</span><span class="p">,</span> <span class="n">m_right</span><span class="p">],</span> <span class="n">sto</span><span class="p">,</span> <span class="n">dclen</span><span class="p">]</span></div>
<div class="viewcode-block" id="parse_miso"><a class="viewcode-back" href="../progdoc.html#txt2ftbl.parse_miso">[docs]</a><span class="k">def</span> <span class="nf">parse_miso</span><span class="p">(</span><span class="n">fmiso</span><span class="p">,</span> <span class="n">clen</span><span class="p">,</span> <span class="n">case_i</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="s2">&quot;Parse isotopic measurements TSV file. Return dict with keys: ms, lab, peak&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">fmiso</span><span class="p">):</span>
        <span class="n">fname</span><span class="o">=</span><span class="n">fmiso</span><span class="o">.</span><span class="n">name</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fname</span><span class="o">=</span><span class="n">fmiso</span>
    <span class="n">fname</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
<span class="c1">#    import pdb; pdb.set_trace()</span>
    <span class="n">df</span><span class="o">=</span><span class="n">tsv2df</span><span class="p">(</span><span class="n">fmiso</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;Metabolite&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s2">&quot;Species&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;Metabolite&quot;</span><span class="p">:</span> <span class="s2">&quot;Specie&quot;</span><span class="p">,</span> <span class="s2">&quot;Species&quot;</span><span class="p">:</span> <span class="s2">&quot;Isospecies&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">case_i</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;Time&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span> <span class="ow">or</span> <span class="nb">sum</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Time&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;parse_miso: instationary option is activated but &#39;Time&#39; column is empty in &#39;</span><span class="si">%s</span><span class="s2">&#39;. Only simulations can be run on result file, not fitting.&quot;</span><span class="o">%</span><span class="n">fname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">]</span>
        <span class="n">df_kin</span><span class="o">=</span><span class="n">pa</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;Time&quot;</span> <span class="ow">in</span> <span class="n">df</span> <span class="ow">and</span> <span class="nb">sum</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Time&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;parse_miso: we are in stationary case but &#39;Time&#39; column is not empty in &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="o">%</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Time&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;Time&quot;</span> <span class="ow">in</span> <span class="n">df</span> <span class="k">else</span> <span class="n">df</span>
    <span class="n">res</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ms&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;lab&quot;</span><span class="p">:</span> <span class="p">[]}</span> <span class="c1"># &#39;peak&#39; and &#39;mean&#39; are transformed into lab</span>
    <span class="c1"># split into kind of measurements: ms, peak, lab</span>
    <span class="n">last_met</span><span class="o">=</span><span class="n">last_frag</span><span class="o">=</span><span class="n">last_dset</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="n">cgr</span><span class="o">=</span><span class="mi">1</span>
    <span class="c1">#import pdb; pdb.set_trace()</span>
    <span class="n">meas_seen</span><span class="o">=</span><span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">kgr</span><span class="p">,</span> <span class="n">ligr</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;Specie&quot;</span><span class="p">,</span> <span class="s2">&quot;Fragment&quot;</span><span class="p">,</span> <span class="s2">&quot;Dataset&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1">#print(&quot;gr=&quot;, kgr, ligr)</span>
        <span class="n">met</span><span class="p">,</span><span class="n">frag</span><span class="p">,</span><span class="n">dset</span><span class="o">=</span><span class="n">kgr</span>
        <span class="c1">#if met == &quot;M_accoa_c&quot;:</span>
        <span class="c1">#    import pdb; pdb.set_trace()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">met</span><span class="p">:</span>
            <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;parse_miso: metabolite name is missing in &#39;</span><span class="si">%s</span><span class="s2">&#39;:</span><span class="si">%d</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">ist</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ligr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:])))</span>
        <span class="n">ist</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ligr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;iline&quot;</span><span class="p">])</span>
        <span class="n">iend</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ligr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;iline&quot;</span><span class="p">])</span>
        <span class="n">mets</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">met</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">)])</span> <span class="c1"># met can be A+B+C, take just the first name</span>
        <span class="n">ibad</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">clen</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mets</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">ibad</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;parse_miso: metabolite &#39;</span><span class="si">%s</span><span class="s2">&#39; was not seen in label transitions, &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%d</span><span class="s2"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mets</span><span class="p">[</span><span class="n">ibad</span><span class="p">]),</span> <span class="n">fname</span><span class="p">,</span> <span class="n">ist</span><span class="p">))</span>
        <span class="c1"># label length in metabolite(s)</span>
        <span class="n">mlen</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">clen</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mets</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mlen</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">mlen</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;parse_miso: metabolites of different lengths (</span><span class="si">%s</span><span class="s2">) are present in &#39;</span><span class="si">%s</span><span class="s2">&#39;, &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">mlen</span><span class="p">)),</span> <span class="n">met</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">ist</span><span class="p">))</span>
        <span class="n">mlen</span><span class="o">=</span><span class="n">mlen</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># standard fragment form: 1,2,...</span>
        <span class="k">if</span> <span class="n">frag</span><span class="p">:</span>
            <span class="n">sfrag</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">frag</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">itvl2li</span><span class="p">(</span><span class="n">v</span><span class="p">)])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)))</span>
            <span class="n">ifr</span><span class="o">=</span><span class="n">sfrag</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
            <span class="n">sfrag</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sfrag</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ifr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mlen</span><span class="p">)</span>
            <span class="n">sfrag</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">ifr</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
        <span class="c1"># common sanity check</span>
        <span class="c1">#if len(ligr) == 1 and df.loc[ligr, &quot;Isospecies&quot;].iloc[0] != &quot;mean&quot;:</span>
        <span class="c1">#    werr(&quot;parse_miso: a group %s of length 1 is not valid, &#39;%s&#39;: %d&quot;%(kgr, fname, ligr[0]+2))</span>
        <span class="n">flen</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ifr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">flen</span> <span class="o">&gt;</span> <span class="n">mlen</span><span class="p">:</span>
            <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;parse_miso: in group </span><span class="si">%s</span><span class="s2">, fragment length </span><span class="si">%d</span><span class="s2"> is greater than metabolite length </span><span class="si">%d</span><span class="s2"> in &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">kgr</span><span class="p">,</span> <span class="n">flen</span><span class="p">,</span> <span class="n">mlen</span><span class="p">,</span> <span class="n">fname</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dset</span><span class="p">:</span>
            <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;parse_miso: dataset name is missing in &#39;</span><span class="si">%s</span><span class="s2">&#39;:</span><span class="si">%d</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">ist</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ligr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:])))</span>
        <span class="k">if</span> <span class="n">ligr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ligr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ligr</span><span class="p">):</span>
            <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;parse_miso: measurements </span><span class="si">%s</span><span class="s2"> are not contiguous in &#39;</span><span class="si">%s</span><span class="s2">&#39;. They occupy rows: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">kgr</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">ligr</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))))</span>
        <span class="c1"># ftbl frag</span>
        <span class="k">if</span> <span class="n">flen</span> <span class="o">==</span> <span class="n">mlen</span><span class="p">:</span>
            <span class="n">ffrag</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ffrag</span><span class="o">=</span><span class="n">frag</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;~&quot;</span><span class="p">)</span>
        <span class="n">val</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ligr</span><span class="p">,</span> <span class="s2">&quot;Value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">sdv</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ligr</span><span class="p">,</span> <span class="s2">&quot;SD&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="c1"># detect kind of species</span>
        <span class="n">spec</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ligr</span><span class="p">,</span> <span class="s2">&quot;Isospecies&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^ *M\d+ *$&quot;</span><span class="p">)):</span>
            <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;ms&quot;</span>
        <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^[ 01x+]+$&quot;</span><span class="p">)):</span>
            <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;lab&quot;</span>
        <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;-&gt;&quot;</span><span class="p">)):</span>
            <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;-&gt;&quot;</span>
            <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;peak&quot;</span>
        <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;→&quot;</span><span class="p">)):</span>
            <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;→&quot;</span>
            <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;peak&quot;</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">ligr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">spec</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
            <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;parse_miso: unknown Isospecies &#39;</span><span class="si">%s</span><span class="s2">&#39; in group </span><span class="si">%s</span><span class="s2"> in &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%d</span><span class="s2">-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">kgr</span><span class="p">,</span> <span class="s2">&quot;, &#39;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spec</span><span class="p">),</span> <span class="n">fname</span><span class="p">,</span> <span class="n">ist</span><span class="p">,</span> <span class="n">iend</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">case_i</span><span class="p">:</span>
            <span class="n">dsp</span><span class="o">=</span><span class="nb">dict</span><span class="p">()</span> <span class="c1"># {specie: times indexes}, e.g. &quot;M0&quot;: vec(&quot;0.1&quot;, &quot;0.2&quot;, ...)</span>
            <span class="n">spli</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">ii0</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">dfgr</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ligr</span><span class="p">,:]</span>
            <span class="k">for</span> <span class="n">sp</span><span class="p">,</span> <span class="n">spi</span> <span class="ow">in</span> <span class="n">dfgr</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;Isospecies&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">dsp</span><span class="p">[</span><span class="n">sp</span><span class="p">]</span><span class="o">=</span><span class="n">spi</span>
                <span class="n">spli</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
                <span class="n">ii0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ligr</span> <span class="o">==</span> <span class="n">spi</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="c1"># check that all SD are the same for all time points</span>
                <span class="n">u</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spi</span><span class="p">,</span> <span class="s2">&quot;SD&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">werr</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;parse_miso: SD must be the same at all time points for </span><span class="si">{</span><span class="n">kgr</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">sp</span><span class="si">}</span><span class="s2">: &#39;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&#39;: &quot;</span><span class="o">+</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spi</span><span class="p">,</span> <span class="s2">&quot;iline&quot;</span><span class="p">]))</span>
            <span class="n">ii0</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">ii0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;ms&quot;</span><span class="p">:</span>
            <span class="c1"># ms group here, like M0, M1</span>
            <span class="c1">#print(&quot;ms gr=&quot;, kgr)</span>
            <span class="n">w</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ligr</span><span class="p">,</span> <span class="s2">&quot;Isospecies&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;str&quot;</span><span class="p">),</span> <span class="s2">&quot; M&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="c1"># ms sanity check</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">w</span> <span class="o">&gt;</span> <span class="n">flen</span><span class="p">):</span>
                <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;parse_miso: invalid MS weight &#39;</span><span class="si">%s</span><span class="s2">&#39; in group </span><span class="si">%s</span><span class="s2"> in &#39;</span><span class="si">%s</span><span class="s2">&#39;:</span><span class="si">%d</span><span class="s2">-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">w</span><span class="o">&gt;</span><span class="n">flen</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">kgr</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">ist</span><span class="p">,</span> <span class="n">iend</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">case_i</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ligr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">flen</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">Excpetion</span><span class="p">(</span><span class="s2">&quot;parse_miso: too many MS entries </span><span class="si">%d</span><span class="s2"> (max </span><span class="si">%d</span><span class="s2"> expected) in group </span><span class="si">%s</span><span class="s2"> in &#39;</span><span class="si">%s</span><span class="s2">&#39;:</span><span class="si">%d</span><span class="s2">-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">kgr</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ligr</span><span class="p">)</span> <span class="p">,</span> <span class="n">flen</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">ist</span><span class="p">,</span> <span class="n">iend</span><span class="p">))</span>
            <span class="c1"># add this group to results</span>
            <span class="c1">#if frag == &quot;&quot;:</span>
            <span class="c1">#    frag=&quot;,&quot;.join(str(i) for i in range(1,flen+1))</span>
            <span class="k">if</span> <span class="n">case_i</span><span class="p">:</span>
                <span class="c1">#if met == &quot;Phe&quot;:</span>
                <span class="c1">#    import pdb; pdb.set_trace()</span>

                <span class="n">res</span><span class="p">[</span><span class="s2">&quot;ms&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{</span><span class="n">met</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">ffrag</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="se">\t</span><span class="s2">NA</span><span class="se">\t</span><span class="si">{</span><span class="n">sdv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">+</span><span class="s2">&quot;   // </span><span class="si">%s</span><span class="s2">: </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">ist</span><span class="p">)]</span>
                <span class="n">res</span><span class="p">[</span><span class="s2">&quot;ms&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t\t\t</span><span class="si">{</span><span class="n">w</span><span class="p">[</span><span class="n">i0</span><span class="p">]</span><span class="si">}</span><span class="se">\t</span><span class="s2">NA</span><span class="se">\t</span><span class="si">{</span><span class="n">sdv</span><span class="p">[</span><span class="n">i0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">+</span><span class="s2">&quot;   // </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ligr</span><span class="p">[</span><span class="n">i0</span><span class="p">],</span> <span class="s2">&quot;iline&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">i0</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">spli</span><span class="p">)),</span> <span class="n">ii0</span><span class="p">[</span><span class="mi">1</span><span class="p">:])]</span>
                <span class="c1">#import pdb; pdb.set_trace()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dfgr</span><span class="p">[</span><span class="n">dfgr</span><span class="p">[</span><span class="s2">&quot;Time&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">sp</span><span class="p">,</span><span class="n">spi</span> <span class="ow">in</span> <span class="n">dsp</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">df_kin</span><span class="o">=</span><span class="n">pa</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_kin</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spi</span><span class="p">,</span> <span class="s2">&quot;Value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spi</span><span class="p">,</span> <span class="s2">&quot;Time&quot;</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;m:</span><span class="si">{</span><span class="n">met</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">ffrag</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">sp</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;iline&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="s2">&quot;ms&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{</span><span class="n">met</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">ffrag</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">sdv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">+</span><span class="s2">&quot;   // </span><span class="si">%s</span><span class="s2">: </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">ist</span><span class="p">)]</span>
                <span class="n">res</span><span class="p">[</span><span class="s2">&quot;ms&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t\t\t</span><span class="si">{</span><span class="n">w</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">val</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">sdv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">+</span><span class="s2">&quot;   // </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ligr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s2">&quot;iline&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ligr</span><span class="p">))]</span>
        <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;lab&quot;</span> <span class="ow">or</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;peak&quot;</span> <span class="ow">or</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
            <span class="c1"># label group (like 01x+1x1)</span>
            <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;lab&quot;</span><span class="p">:</span>
                <span class="n">labs</span><span class="o">=</span><span class="p">[[</span><span class="n">vv</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">)]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ligr</span><span class="p">,</span> <span class="s2">&quot;Isospecies&quot;</span><span class="p">]]</span>
            <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;peak&quot;</span><span class="p">:</span>
                <span class="n">b</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">mlen</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="c1"># base where lab will be injected</span>
                <span class="n">b</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
                <span class="n">b</span><span class="p">[</span><span class="n">ifr</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;0&quot;</span>
                <span class="n">labs</span><span class="o">=</span><span class="p">[]</span>
                <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">:</span>
                    <span class="n">li</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">peak</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">sep</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">()])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
                    <span class="n">tmp</span><span class="o">=</span><span class="n">b</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">tmp</span><span class="p">[</span><span class="n">li</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;1&quot;</span>
                    <span class="n">labs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="n">ifr</span><span class="p">])])</span>
                <span class="c1">#import pdb; pdb.set_trace()</span>
            <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
                <span class="n">b</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">mlen</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="c1"># base where lab will be injected</span>
                <span class="n">b</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
                <span class="n">labs</span><span class="o">=</span><span class="p">[[</span><span class="s2">&quot;x&quot;</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="s2">&quot;1&quot;</span><span class="o">+</span><span class="s2">&quot;x&quot;</span><span class="o">*</span><span class="p">(</span><span class="n">flen</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">flen</span><span class="p">)]]</span>
                <span class="k">if</span> <span class="n">flen</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">val</span><span class="p">[</span><span class="n">val</span> <span class="o">!=</span> <span class="s1">&#39;NA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vsadd</span><span class="p">(</span><span class="n">vsadd</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">[</span><span class="n">val</span> <span class="o">!=</span> <span class="s1">&#39;NA&#39;</span><span class="p">]),</span> <span class="s2">&quot;)*&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">flen</span><span class="p">))</span>
                    <span class="n">sdv</span> <span class="o">=</span> <span class="n">vsadd</span><span class="p">(</span><span class="n">vsadd</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="n">sdv</span><span class="p">),</span> <span class="s2">&quot;)*&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">flen</span><span class="p">))</span>
            <span class="c1"># label sanity check</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">li</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labs</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">li</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">!=</span> <span class="n">flen</span><span class="p">:</span>
                        <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;parse_miso: entry &#39;</span><span class="si">%s</span><span class="s2">&#39; has length </span><span class="si">%d</span><span class="s2"> different from fragment length </span><span class="si">%d</span><span class="s2">, &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="n">flen</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ligr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s2">&quot;iline&quot;</span><span class="p">]))</span>
            <span class="c1"># inject fragment species into full molecule</span>
            <span class="k">if</span> <span class="n">flen</span> <span class="o">&lt;</span> <span class="n">mlen</span><span class="p">:</span>
                <span class="n">b</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">mlen</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="c1"># base where lab will be injected</span>
                <span class="n">b</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">li</span> <span class="ow">in</span> <span class="n">labs</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">li</span><span class="p">)):</span>
                        <span class="n">tmp</span><span class="o">=</span><span class="n">b</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">tmp</span><span class="p">[</span><span class="n">ifr</span><span class="p">]</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">li</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">li</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
            <span class="c1"># normalize or not?</span>
            <span class="n">collab</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">v</span> <span class="k">for</span> <span class="n">li</span> <span class="ow">in</span> <span class="n">labs</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">li</span><span class="p">)</span> <span class="c1"># will be collapsed labels.</span>
            <span class="c1"># the group is normalizable if collapsed labs is composed of only &quot;x&quot;</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">collab</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">collab</span><span class="p">)</span> <span class="c1"># if there are two collapsible labs, they will be neighbors</span>
                <span class="n">found</span><span class="o">=</span><span class="kc">False</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">collab</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">collab</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">s</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">collab</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">n</span> <span class="c1"># string</span>
                    <span class="n">n</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">collab</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span> <span class="c1"># next</span>
                    <span class="n">cdif</span><span class="o">=</span><span class="n">s</span> <span class="o">!=</span> <span class="n">n</span>
                    <span class="k">if</span> <span class="n">cdif</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">idif</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cdif</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">found</span><span class="o">=</span><span class="n">s</span><span class="p">[</span><span class="n">idif</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span> <span class="ow">and</span> <span class="n">n</span><span class="p">[</span><span class="n">idif</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span>
                        <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
                            <span class="n">s</span><span class="p">[</span><span class="n">idif</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;x&quot;</span>
                            <span class="n">collab</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                            <span class="k">del</span><span class="p">(</span><span class="n">collab</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                            <span class="k">break</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">collab</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">collab</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">collab</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;x&quot;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">collab</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="s2">&quot;NA&quot;</span><span class="p">):</span>
                <span class="n">norma</span><span class="o">=</span><span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">norma</span><span class="o">=</span><span class="kc">False</span>
            <span class="c1"># add this group to results</span>
            <span class="c1">#	META_NAME	CUM_GROUP	VALUE	DEVIATION	CUM_CONSTRAINTS</span>
            <span class="k">if</span> <span class="n">case_i</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="s2">&quot;lab&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{</span><span class="n">met</span><span class="si">}</span><span class="se">\t</span><span class="s2">1</span><span class="se">\t</span><span class="si">{</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">sdv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">+</span><span class="s2">&quot;+&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="o">+</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">labs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;   // </span><span class="si">%s</span><span class="s2">: </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">ist</span><span class="p">)]</span>
                <span class="n">res</span><span class="p">[</span><span class="s2">&quot;lab&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="k">if</span> <span class="n">norma</span> <span class="k">else</span> <span class="mi">1</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">val</span><span class="p">[</span><span class="n">i0</span><span class="p">]</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">sdv</span><span class="p">[</span><span class="n">i0</span><span class="p">]</span><span class="si">}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">+</span><span class="s2">&quot;+&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="o">+</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">labs</span><span class="p">[</span><span class="n">i0</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;   // </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ligr</span><span class="p">[</span><span class="n">i0</span><span class="p">],</span> <span class="s2">&quot;iline&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">i0</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">spli</span><span class="p">)),</span> <span class="n">ii0</span><span class="p">[</span><span class="mi">1</span><span class="p">:])]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dfgr</span><span class="p">[</span><span class="n">dfgr</span><span class="p">[</span><span class="s2">&quot;Time&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,(</span><span class="n">sp</span><span class="p">,</span><span class="n">spi</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dsp</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                        <span class="c1">#import pdb; pdb.set_trace()</span>
                        <span class="n">df_kin</span><span class="o">=</span><span class="n">pa</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_kin</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spi</span><span class="p">,</span> <span class="s2">&quot;Value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spi</span><span class="p">,</span> <span class="s2">&quot;Time&quot;</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;l:</span><span class="si">{</span><span class="n">met</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="s1">&#39;+&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="o">+</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">labs</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="si">}</span><span class="s2">:NA&quot;</span><span class="p">])])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">met</span> <span class="o">!=</span> <span class="n">last_met</span> <span class="ow">or</span> <span class="n">frag</span> <span class="o">!=</span> <span class="n">last_frag</span><span class="p">:</span>
                    <span class="n">last_met</span><span class="o">=</span><span class="n">met</span>
                    <span class="n">last_frag</span><span class="o">=</span><span class="n">frag</span>
                <span class="k">elif</span> <span class="n">dset</span> <span class="o">!=</span> <span class="n">last_dset</span><span class="p">:</span>
                    <span class="n">last_dset</span><span class="o">=</span><span class="n">dset</span>
                <span class="n">res</span><span class="p">[</span><span class="s2">&quot;lab&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{</span><span class="n">met</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">cgr</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">sdv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">+</span><span class="s2">&quot;+&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="o">+</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">labs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;   // </span><span class="si">%s</span><span class="s2">: </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">ist</span><span class="p">)]</span>
                <span class="n">res</span><span class="p">[</span><span class="s2">&quot;lab&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="n">cgr</span> <span class="k">if</span> <span class="n">norma</span> <span class="k">else</span> <span class="n">cgr</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">val</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">sdv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">+</span><span class="s2">&quot;+&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="o">+</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">labs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;   // </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ligr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s2">&quot;iline&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ligr</span><span class="p">))]</span>
                <span class="n">cgr</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ligr</span><span class="p">)</span> <span class="k">if</span> <span class="n">norma</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">df_kin</span><span class="p">)</span> <span class="k">if</span> <span class="n">case_i</span> <span class="k">else</span> <span class="n">res</span></div>
<div class="viewcode-block" id="parse_linp"><a class="viewcode-back" href="../progdoc.html#txt2ftbl.parse_linp">[docs]</a><span class="k">def</span> <span class="nf">parse_linp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">clen</span><span class="o">=</span><span class="p">{}):</span>
    <span class="s2">&quot;Parse label input TSV file. Return a list of lines to add to ftbl&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="n">fname</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">name</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fname</span><span class="o">=</span><span class="n">f</span>
    <span class="n">fname</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    
    <span class="n">df</span><span class="o">=</span><span class="n">tsv2df</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;Metabolite&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;Metabolite&quot;</span><span class="p">:</span> <span class="s2">&quot;Specie&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1">#print(&quot;df=&quot;, df)</span>
    <span class="n">res</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">met</span><span class="p">,</span> <span class="n">ligr</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;Specie&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">mlen</span><span class="o">=</span><span class="n">clen</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">met</span><span class="p">)</span>
        <span class="n">il</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ligr</span><span class="p">,</span> <span class="s2">&quot;iline&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="c1"># strings</span>
        <span class="c1"># sanity check</span>
        <span class="k">if</span> <span class="n">clen</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mlen</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;parse_linp: specie &#39;</span><span class="si">%s</span><span class="s2">&#39; was not seen in label transitions, &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">met</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">il</span><span class="p">)))</span>
            <span class="n">ibad</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">!=</span> <span class="n">mlen</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ligr</span><span class="p">,</span> <span class="s2">&quot;Isotopomer&quot;</span><span class="p">]])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ibad</span><span class="p">):</span>
                <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;parse_linp: for specie &#39;</span><span class="si">%s</span><span class="s2">&#39;, isotopomer length(s) (</span><span class="si">%s</span><span class="s2">) differ from its labeling atom length </span><span class="si">%d</span><span class="s2"> in &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">met</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ligr</span><span class="p">[</span><span class="n">ibad</span><span class="p">],</span> <span class="s2">&quot;Isotopomer&quot;</span><span class="p">]),</span> <span class="n">mlen</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">il</span><span class="p">)))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ligr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">**</span><span class="n">mlen</span><span class="p">:</span>
                <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;parse_linp: too many isotopomers </span><span class="si">%d</span><span class="s2"> for metabolite &#39;</span><span class="si">%s</span><span class="s2">&#39; in &#39;</span><span class="si">%s</span><span class="s2">&#39;:</span><span class="si">%s</span><span class="s2">-</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ligr</span><span class="p">),</span> <span class="n">met</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">il</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">il</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ligr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ligr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ligr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;parse_linp: for metabolite &#39;</span><span class="si">%s</span><span class="s2">&#39;, label input is not continguous in &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">-</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">met</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">il</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">il</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="s2">#</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="s2">   // </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">met</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ligr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;Isotopomer&quot;</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ligr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;Value&quot;</span><span class="p">],</span> <span class="n">fname</span><span class="p">,</span> <span class="n">il</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">#</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="s2">   // </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ligr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s2">&quot;Isotopomer&quot;</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ligr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s2">&quot;Value&quot;</span><span class="p">],</span> <span class="n">fname</span><span class="p">,</span> <span class="n">il</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ligr</span><span class="p">))]</span>
    <span class="k">return</span> <span class="n">res</span></div>
<div class="viewcode-block" id="parse_mflux"><a class="viewcode-back" href="../progdoc.html#txt2ftbl.parse_mflux">[docs]</a><span class="k">def</span> <span class="nf">parse_mflux</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dfl</span><span class="o">=</span><span class="p">{}):</span>
    <span class="s2">&quot;Parse flux measurements TSV file. Return a list of lines to add to ftbl&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="n">fname</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">name</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fname</span><span class="o">=</span><span class="n">f</span>
    <span class="n">fname</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    
    <span class="n">df</span><span class="o">=</span><span class="n">tsv2df</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="c1">#print(&quot;df=&quot;, df)</span>
    <span class="n">res</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">flux</span><span class="p">,</span><span class="n">ligr</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;Flux&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">il</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ligr</span><span class="p">,</span> <span class="s2">&quot;iline&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="c1"># strings</span>
        <span class="c1"># sanity check</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ligr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;parse_mflux: flux &#39;</span><span class="si">%s</span><span class="s2">&#39; has more than 1 measurement in &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">flux</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">il</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">dfl</span> <span class="ow">and</span> <span class="n">flux</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dfl</span><span class="p">:</span>
            <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;parse_mflux: flux &#39;</span><span class="si">%s</span><span class="s2">&#39; was not seen in metabolic network, &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">flux</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">il</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="s2">   // </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">flux</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ligr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;Value&quot;</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ligr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;SD&quot;</span><span class="p">],</span> <span class="n">fname</span><span class="p">,</span> <span class="n">il</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">res</span></div>
<div class="viewcode-block" id="parse_opt"><a class="viewcode-back" href="../progdoc.html#txt2ftbl.parse_opt">[docs]</a><span class="k">def</span> <span class="nf">parse_opt</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="s2">&quot;Parse options TSV file. Return a list of lines to add to ftbl&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="n">fname</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">name</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fname</span><span class="o">=</span><span class="n">f</span>
    <span class="n">fname</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    
    <span class="n">df</span><span class="o">=</span><span class="n">tsv2df</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="s2">&quot;Value&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">res</span><span class="o">=</span><span class="n">vsadd</span><span class="p">(</span><span class="n">vsadd</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">vsadd</span><span class="p">(</span><span class="n">df</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)),</span> <span class="n">df</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">res</span></div>
<div class="viewcode-block" id="parse_tvar"><a class="viewcode-back" href="../progdoc.html#txt2ftbl.parse_tvar">[docs]</a><span class="k">def</span> <span class="nf">parse_tvar</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dfl</span><span class="o">=</span><span class="p">{},</span> <span class="n">itnl_met</span><span class="o">=</span><span class="nb">set</span><span class="p">()):</span>
    <span class="s2">&quot;Parse variable type TSV file. Return a tuple of a dict and a list with lines to add to ftbl&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="n">fname</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">name</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fname</span><span class="o">=</span><span class="n">f</span>
    <span class="n">fname</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    
    <span class="n">df</span><span class="o">=</span><span class="n">tsv2df</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="c1">#print(&quot;df=&quot;, df)</span>
    <span class="n">fl</span><span class="o">=</span><span class="p">{}</span>
    <span class="n">mets</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">kgr</span><span class="p">,</span><span class="n">ligr</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;Kind&quot;</span><span class="p">,</span> <span class="s2">&quot;Name&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">plain_natural_key</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]))):</span>
        <span class="n">il</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ligr</span><span class="p">,</span> <span class="s2">&quot;iline&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="c1"># strings</span>
        <span class="n">kind</span><span class="p">,</span><span class="n">nm</span><span class="o">=</span><span class="n">kgr</span>
        <span class="c1">#if kind == &quot;NET&quot;:</span>
        <span class="c1">#    import pdb; pdb.set_trace();</span>
        <span class="c1"># sanity check</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;NET&quot;</span><span class="p">,</span> <span class="s2">&quot;XCH&quot;</span><span class="p">,</span> <span class="s2">&quot;METAB&quot;</span><span class="p">):</span>
            <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;parse_tvar: kind &#39;</span><span class="si">%s</span><span class="s2">&#39; is unknown (expected one of NET, XCH or METAB) in &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">il</span><span class="p">)))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ligr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;parse_tvar: groupe &#39;</span><span class="si">%s</span><span class="s2">&#39; has more than 1 entry in &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">kgr</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">il</span><span class="p">)))</span>
        <span class="n">val</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ligr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;Value&quot;</span><span class="p">]</span>
        <span class="n">ty</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ligr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;Type&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ty</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;F&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">):</span>
            <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;parse_tvar: type &#39;</span><span class="si">%s</span><span class="s2">&#39; is not valid (expected one of F, D or C) in &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ty</span><span class="p">,</span> <span class="n">il</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">ty</span> <span class="o">!=</span> <span class="s2">&quot;D&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">val</span><span class="p">:</span>
            <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;parse_tvar: type &#39;</span><span class="si">%s</span><span class="s2">&#39; supposes non empty value in &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ty</span><span class="p">,</span> <span class="n">il</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;METAB&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">itnl_met</span> <span class="ow">and</span> <span class="n">nm</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">itnl_met</span><span class="p">:</span>
                <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;parse_tvar: metabolite &#39;</span><span class="si">%s</span><span class="s2">&#39; was not seen in internal metabolites, &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">nm</span><span class="p">,</span> <span class="n">il</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">ty</span> <span class="o">!=</span> <span class="s2">&quot;C&quot;</span><span class="p">:</span>
                <span class="n">val</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="o">+</span><span class="n">val</span>
            <span class="n">mets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="s2">   // </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">nm</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">il</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dfl</span> <span class="ow">and</span> <span class="n">nm</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dfl</span><span class="p">:</span>
                <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;parse_tvar: flux &#39;</span><span class="si">%s</span><span class="s2">&#39; was not seen in metabolic network, &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">nm</span><span class="p">,</span> <span class="n">il</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">fl</span><span class="p">[</span><span class="n">kind</span><span class="p">]</span><span class="o">=</span><span class="n">fl</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">fl</span><span class="p">[</span><span class="n">kind</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="s2">   // </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">nm</span><span class="p">,</span> <span class="n">ty</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">il</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">fl</span><span class="p">,</span> <span class="n">mets</span><span class="p">)</span></div>
<div class="viewcode-block" id="parse_cnstr"><a class="viewcode-back" href="../progdoc.html#txt2ftbl.parse_cnstr">[docs]</a><span class="k">def</span> <span class="nf">parse_cnstr</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="s2">&quot;Parse constraint TSV file. Return a tuple of 2 dicts (eq, ineq) with lines to add to ftbl&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="n">fname</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">name</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fname</span><span class="o">=</span><span class="n">f</span>
    <span class="n">fname</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    
    <span class="n">df</span><span class="o">=</span><span class="n">tsv2df</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="c1">#print(&quot;df=&quot;, df)</span>
    <span class="n">eq</span><span class="o">=</span><span class="p">{}</span>
    <span class="n">ineq</span><span class="o">=</span><span class="p">{}</span>
    <span class="k">for</span> <span class="n">kgr</span><span class="p">,</span><span class="n">ligr</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;Kind&quot;</span><span class="p">,</span> <span class="s2">&quot;Formula&quot;</span><span class="p">,</span> <span class="s2">&quot;Operator&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">il</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ligr</span><span class="p">,</span> <span class="s2">&quot;iline&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="c1"># strings</span>
        <span class="n">kind</span><span class="p">,</span><span class="n">frml</span><span class="p">,</span><span class="n">op</span><span class="o">=</span><span class="n">kgr</span>
        <span class="c1"># sanity check</span>
        <span class="k">if</span> <span class="n">op</span> <span class="o">!=</span> <span class="s2">&quot;==&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">invcomp</span><span class="p">:</span>
            <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;parse_cnstr: operator &#39;</span><span class="si">%s</span><span class="s2">&#39; is unknown in &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">il</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;NET&quot;</span><span class="p">,</span> <span class="s2">&quot;XCH&quot;</span><span class="p">,</span> <span class="s2">&quot;METAB&quot;</span><span class="p">):</span>
            <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;parse_cnstr: kind &#39;</span><span class="si">%s</span><span class="s2">&#39; is unknown (expected one of NET, XCH or METAB) in &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">il</span><span class="p">)))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ligr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;parse_cnstr: formula &#39;</span><span class="si">%s</span><span class="s2">&#39; has more than 1 entry in &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">frml</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">il</span><span class="p">)))</span>
        <span class="n">val</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ligr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;Value&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;==&quot;</span><span class="p">:</span>
            <span class="n">eq</span><span class="p">[</span><span class="n">kind</span><span class="p">]</span><span class="o">=</span><span class="n">eq</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">eq</span><span class="p">[</span><span class="n">kind</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="s2">   // </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">frml</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">il</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">op</span><span class="o">=</span><span class="n">invcomp</span><span class="p">[</span><span class="n">op</span><span class="p">]</span>
            <span class="n">ineq</span><span class="p">[</span><span class="n">kind</span><span class="p">]</span><span class="o">=</span><span class="n">ineq</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">ineq</span><span class="p">[</span><span class="n">kind</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="s2">   // </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">frml</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">il</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="c1">#import pdb; pdb.set_trace()</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">eq</span><span class="p">,</span> <span class="n">ineq</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span></div>
<div class="viewcode-block" id="parse_mmet"><a class="viewcode-back" href="../progdoc.html#txt2ftbl.parse_mmet">[docs]</a><span class="k">def</span> <span class="nf">parse_mmet</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">smet</span><span class="o">=</span><span class="nb">set</span><span class="p">()):</span>
    <span class="s2">&quot;Parse metabolite concentration measurements TSV file. Return a list of lines to add to ftbl&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="n">fname</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">name</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fname</span><span class="o">=</span><span class="n">f</span>
    <span class="n">fname</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    
    <span class="n">df</span><span class="o">=</span><span class="n">tsv2df</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;Metabolite&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;Metabolite&quot;</span><span class="p">:</span> <span class="s2">&quot;Specie&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1">#print(&quot;df=&quot;, df)</span>
    <span class="n">res</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">met</span><span class="p">,</span><span class="n">ligr</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;Specie&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">il</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ligr</span><span class="p">,</span> <span class="s2">&quot;iline&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="c1"># strings</span>
        <span class="c1"># sanity check</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ligr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;parse_mmet: specie &#39;</span><span class="si">%s</span><span class="s2">&#39; has more than 1 measurement in &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">met</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">il</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">smet</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">smet</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">met</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">)):</span>
            <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;parse_mmet: specie &#39;</span><span class="si">%s</span><span class="s2">&#39; was not seen in internal metabolites of network, &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">met</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">il</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="s2">   // </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">met</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ligr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;Value&quot;</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ligr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;SD&quot;</span><span class="p">],</span> <span class="n">fname</span><span class="p">,</span> <span class="n">il</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="compile"><a class="viewcode-back" href="../progdoc.html#txt2ftbl.compile">[docs]</a><span class="k">def</span> <span class="nf">compile</span><span class="p">(</span><span class="n">mtf</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">case_i</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">clen</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="s2">&quot;Compile FTBL content from mtf names: netw, miso etc. Return a dict of ftbl lines&quot;</span>
    <span class="c1"># dict of ftbl sections. Contains list of lines to be completed by compilation</span>
    <span class="n">dsec</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;proj&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;PROJECT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;	NAME	VERSION	FORMAT	DATE	COMMENT&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s2">&quot;netw&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;NETWORK&quot;</span><span class="p">,</span>
            <span class="s2">&quot;	FLUX_NAME	EDUCT_1	EDUCT_2	PRODUCT_1	PRODUCT_2&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s2">&quot;notr&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;NOTRACER_NETWORK&quot;</span><span class="p">,</span>
            <span class="s2">&quot;	FLUX_NAME	EQUATION&quot;</span><span class="p">,</span>
        <span class="p">],</span>
       <span class="s2">&quot;flux&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;FLUXES&quot;</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;NET&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;	NET&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;		NAME	FCD	VALUE(F/C)	ED_WEIGHT	LOW(F)	INC(F)	UP(F)&quot;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="s2">&quot;XCH&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;	XCH&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;		NAME	FCD	VALUE(F/C)	ED_WEIGHT	LOW(F)	INC(F)	UP(F)&quot;</span><span class="p">,</span>
                <span class="p">],</span>
            <span class="p">},</span>
        <span class="p">],</span>
        <span class="s2">&quot;met_pool&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;METABOLITE_POOLS&quot;</span><span class="p">,</span>
            <span class="s2">&quot;	META_NAME	META_SIZE&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s2">&quot;eq&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;EQUALITIES&quot;</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;NET&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;	NET&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;		VALUE	FORMULA&quot;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="s2">&quot;XCH&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;	XCH&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;		VALUE	FORMULA&quot;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="s2">&quot;METAB&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;	METAB&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;		VALUE	FORMULA&quot;</span><span class="p">,</span>
                <span class="p">],</span>
            <span class="p">},</span>
        <span class="p">],</span>
        <span class="s2">&quot;ineq&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;INEQUALITIES&quot;</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;NET&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;	NET&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;		VALUE	COMP	FORMULA&quot;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="s2">&quot;XCH&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;	XCH&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;		VALUE	COMP	FORMULA&quot;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="s2">&quot;METAB&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;	METAB&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;		VALUE	COMP	FORMULA&quot;</span><span class="p">,</span>
                <span class="p">],</span>
            <span class="p">},</span>
        <span class="p">],</span>
        <span class="s2">&quot;linp&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;LABEL_INPUT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;	META_NAME	ISOTOPOMER	VALUE&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s2">&quot;mflux&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;FLUX_MEASUREMENTS&quot;</span><span class="p">,</span>
            <span class="s2">&quot;	FLUX_NAME	VALUE	DEVIATION&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s2">&quot;meas_lab&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;LABEL_MEASUREMENTS&quot;</span><span class="p">,</span>
            <span class="s2">&quot;	META_NAME	CUM_GROUP	VALUE	DEVIATION	CUM_CONSTRAINTS&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s2">&quot;meas_peak&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;PEAK_MEASUREMENTS&quot;</span><span class="p">,</span>
            <span class="s2">&quot;	META_NAME	PEAK_NO	VALUE_S	VALUE_D-	VALUE_D+	VALUE_DD	VALUE_T	DEVIATION_S	DEVIATION_D-	DEVIATION_D+	DEVIATION_DD/T&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s2">&quot;meas_ms&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;MASS_SPECTROMETRY&quot;</span><span class="p">,</span>
            <span class="s2">&quot;	META_NAME	FRAGMENT	WEIGHT	VALUE	DEVIATION&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s2">&quot;mmet&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;METAB_MEASUREMENTS&quot;</span><span class="p">,</span>
            <span class="s2">&quot;	META_NAME	VALUE	DEVIATION&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s2">&quot;opt&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;OPTIONS&quot;</span><span class="p">,</span>
            <span class="s2">&quot;	OPT_NAME	OPT_VALUE&quot;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">}</span>
    <span class="n">dsec_empty</span><span class="o">=</span><span class="n">dsec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># Parse netw file if not empty</span>
    <span class="k">if</span> <span class="s2">&quot;netw&quot;</span> <span class="ow">in</span> <span class="n">mtf</span> <span class="ow">and</span> <span class="n">mtf</span><span class="p">[</span><span class="s2">&quot;netw&quot;</span><span class="p">]:</span>
        <span class="n">pth</span><span class="o">=</span><span class="n">try_ext</span><span class="p">(</span><span class="n">mtf</span><span class="p">[</span><span class="s2">&quot;netw&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;netw&quot;</span><span class="p">,</span> <span class="s2">&quot;txt&quot;</span><span class="p">])</span>
        <span class="p">(</span><span class="n">netw</span><span class="p">,</span> <span class="n">notr_netw</span><span class="p">,</span> <span class="n">eqs</span><span class="p">,</span> <span class="n">ineqs</span><span class="p">,</span> <span class="n">fluxes</span><span class="p">,</span> <span class="p">(</span><span class="n">m_left</span><span class="p">,</span> <span class="n">m_right</span><span class="p">),</span> <span class="n">sto</span><span class="p">,</span> <span class="n">dclen</span><span class="p">)</span><span class="o">=</span><span class="n">txt_parse</span><span class="p">(</span><span class="n">pth</span><span class="p">)</span>
        <span class="c1"># build afl matrix: each row is a balance on an internal metabolite, each column is a flux values</span>
        <span class="n">nb_flux</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">sto</span><span class="p">)</span>
        <span class="n">nm_flux</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">sto</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">plain_natural_key</span><span class="p">)</span>
        <span class="n">m_l</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="n">m_left</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">m_r</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="n">m_right</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">m_inp</span><span class="o">=</span><span class="n">m_l</span><span class="o">-</span><span class="n">m_r</span>
        <span class="n">m_out</span><span class="o">=</span><span class="n">m_r</span><span class="o">-</span><span class="n">m_l</span>
        <span class="n">itnal_met</span><span class="o">=</span><span class="p">(</span><span class="n">m_l</span><span class="o">|</span><span class="n">m_r</span><span class="p">)</span> <span class="o">-</span> <span class="n">m_inp</span> <span class="o">-</span> <span class="n">m_out</span>
        <span class="n">nm_met</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">itnal_met</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">plain_natural_key</span><span class="p">)</span>
        <span class="n">fl2i</span><span class="o">=</span><span class="nb">dict</span><span class="p">((</span><span class="n">fl</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nm_flux</span><span class="p">))</span>
        <span class="n">met2i</span><span class="o">=</span><span class="nb">dict</span><span class="p">((</span><span class="n">m</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nm_met</span><span class="p">))</span>
        <span class="n">afl</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">nm_met</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">eqs</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">nm_flux</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">fl</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">sto</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">m</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">met2i</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">afl</span><span class="p">[</span><span class="n">met2i</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="n">fl2i</span><span class="p">[</span><span class="n">fl</span><span class="p">]]</span><span class="o">=</span><span class="n">c</span>
        <span class="c1"># add netw equations</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">eq</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">eqs</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">fls</span><span class="o">=</span><span class="n">eq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; - &quot;</span><span class="p">)</span>
            <span class="n">afl</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">nm_met</span><span class="p">)</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">fl2i</span><span class="p">[</span><span class="n">fls</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span><span class="o">=</span><span class="mf">1.</span>
            <span class="n">afl</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">nm_met</span><span class="p">)</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">fl2i</span><span class="p">[</span><span class="n">fls</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span><span class="o">=-</span><span class="mf">1.</span>
        <span class="k">if</span> <span class="n">nb_flux</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># qr(afl)</span>
            <span class="n">q</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="n">linalg</span><span class="o">.</span><span class="n">qr</span><span class="p">(</span><span class="n">afl</span><span class="p">,</span> <span class="n">pivoting</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">d</span><span class="o">=</span><span class="n">diag</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
                <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;Stoechiometrix matrix is 0&quot;</span><span class="p">)</span>
            <span class="n">rank</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">d</span><span class="o">/</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">1.e-10</span><span class="p">)</span>
            <span class="c1"># free fluxes are the last in pivots</span>
            <span class="n">ff</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="n">nm_flux</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">p</span><span class="p">[</span><span class="n">rank</span><span class="p">:])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ff</span><span class="o">=</span><span class="p">[]</span>
        <span class="c1"># prepare header</span>
        <span class="n">base</span><span class="o">=</span><span class="n">mtf</span><span class="p">[</span><span class="s2">&quot;netw&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
        <span class="n">dsec</span><span class="p">[</span><span class="s2">&quot;proj&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;	</span><span class="si">%s</span><span class="s2">	</span><span class="si">%s</span><span class="s2">			command=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)]</span>
        <span class="c1"># prepare the ftbl content</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">netw</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                <span class="n">dsec</span><span class="p">[</span><span class="s2">&quot;netw&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">row</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\r</span><span class="s2">&quot;</span><span class="p">)]</span>
                <span class="k">continue</span>
            <span class="n">dsec</span><span class="p">[</span><span class="s2">&quot;netw&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="c1"># reac name</span>
            <span class="c1"># input metabs</span>
            <span class="n">carbs</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span>
            <span class="n">imetab</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">coef</span><span class="p">,</span> <span class="n">metab</span><span class="p">,</span> <span class="n">carb</span><span class="p">)</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">imetab</span><span class="o">=</span><span class="n">imetab</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">dsec</span><span class="p">[</span><span class="s2">&quot;netw&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="si">%s%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">coef</span><span class="o">+</span><span class="s2">&quot;*&quot;</span> <span class="k">if</span> <span class="n">coef</span> <span class="ow">and</span> <span class="n">coef</span> <span class="o">!=</span> <span class="s2">&quot;1&quot;</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">metab</span><span class="p">)</span>
                <span class="n">carbs</span><span class="o">=</span><span class="n">carbs</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">((</span><span class="s2">&quot;#&quot;</span><span class="o">+</span><span class="n">carb</span><span class="p">)</span> <span class="k">if</span> <span class="n">metab</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">imetab</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1"># complete by empty metabolite</span>
                <span class="n">dsec</span><span class="p">[</span><span class="s2">&quot;netw&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span>
                <span class="n">carbs</span><span class="o">=</span><span class="n">carbs</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span>
            <span class="c1"># output metabs</span>
            <span class="n">imetab</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">coef</span><span class="p">,</span> <span class="n">metab</span><span class="p">,</span> <span class="n">carb</span><span class="p">)</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">imetab</span><span class="o">=</span><span class="n">imetab</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">dsec</span><span class="p">[</span><span class="s2">&quot;netw&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">metab</span>
                <span class="n">carbs</span><span class="o">=</span><span class="n">carbs</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">((</span><span class="s2">&quot;#&quot;</span><span class="o">+</span><span class="n">carb</span><span class="p">)</span> <span class="k">if</span> <span class="n">metab</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">dsec</span><span class="p">[</span><span class="s2">&quot;netw&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">carbs</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">notr_netw</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                <span class="n">dsec</span><span class="p">[</span><span class="s2">&quot;notr&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">row</span><span class="p">]</span>
                <span class="k">continue</span>
            <span class="n">dsec</span><span class="p">[</span><span class="s2">&quot;notr&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot; = &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">c</span><span class="o">+</span><span class="s2">&quot;*&quot;</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">!=</span> <span class="s2">&quot;1&quot;</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">+</span><span class="n">m</span>  <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="n">side</span><span class="p">)</span> <span class="k">for</span> <span class="n">side</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]))]</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">eqs</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">dsec</span><span class="p">[</span><span class="s2">&quot;eq&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;NET&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">e</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">eqs</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">dsec</span><span class="p">[</span><span class="s2">&quot;eq&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;XCH&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">e</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ine</span> <span class="ow">in</span> <span class="n">ineqs</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">dsec</span><span class="p">[</span><span class="s2">&quot;ineq&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;NET&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">ine</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;linp&quot;</span> <span class="ow">in</span> <span class="n">mtf</span><span class="p">:</span>
            <span class="c1"># add default full label input</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">m_inp</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">plain_natural_key</span><span class="p">):</span>
                <span class="n">dsec</span><span class="p">[</span><span class="s2">&quot;linp&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="s2">#</span><span class="si">%s</span><span class="se">\t</span><span class="s2">1.0&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="o">*</span><span class="n">dclen</span><span class="p">[</span><span class="n">m</span><span class="p">])]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dclen</span><span class="o">=</span><span class="p">{}</span> <span class="k">if</span> <span class="n">clen</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">clen</span>
        <span class="n">itnal_met</span><span class="o">=</span><span class="nb">set</span><span class="p">()</span>
        <span class="n">sto</span><span class="o">=</span><span class="p">{}</span>
        <span class="n">fluxes</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">sfl</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="n">sto</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="c1"># set of fluxes</span>
    <span class="k">if</span> <span class="s2">&quot;cnstr&quot;</span> <span class="ow">in</span> <span class="n">mtf</span> <span class="ow">and</span> <span class="n">mtf</span><span class="p">[</span><span class="s2">&quot;cnstr&quot;</span><span class="p">]:</span>
        <span class="n">pth</span><span class="o">=</span><span class="n">try_ext</span><span class="p">(</span><span class="n">mtf</span><span class="p">[</span><span class="s2">&quot;cnstr&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;cntsr&quot;</span><span class="p">,</span> <span class="s2">&quot;tsv&quot;</span><span class="p">,</span> <span class="s2">&quot;txt&quot;</span><span class="p">])</span>
        <span class="n">ce</span><span class="p">,</span><span class="n">ci</span><span class="p">,</span><span class="n">df</span><span class="o">=</span><span class="n">parse_cnstr</span><span class="p">(</span><span class="n">pth</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">ce</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">dsec</span><span class="p">[</span><span class="s2">&quot;eq&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="n">v</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">ci</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">dsec</span><span class="p">[</span><span class="s2">&quot;ineq&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="n">v</span>
        <span class="c1"># complete flux set by those from eq:net</span>
        
        <span class="c1">#import pdb; pdb.set_trace()</span>
        <span class="k">for</span> <span class="n">eq</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Kind&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;NET&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Operator&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;==&quot;</span><span class="p">)][</span><span class="s2">&quot;Formula&quot;</span><span class="p">]:</span>
            <span class="n">sfl</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">(</span><span class="n">formula2dict</span><span class="p">(</span><span class="n">eq</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">if</span> <span class="s2">&quot;miso&quot;</span> <span class="ow">in</span> <span class="n">mtf</span> <span class="ow">and</span> <span class="n">mtf</span><span class="p">[</span><span class="s2">&quot;miso&quot;</span><span class="p">]:</span>
        <span class="n">pth</span><span class="o">=</span><span class="n">try_ext</span><span class="p">(</span><span class="n">mtf</span><span class="p">[</span><span class="s2">&quot;miso&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;miso&quot;</span><span class="p">,</span> <span class="s2">&quot;tsv&quot;</span><span class="p">,</span> <span class="s2">&quot;txt&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">case_i</span><span class="p">:</span>
            <span class="n">meas</span><span class="p">,</span> <span class="n">df_kin</span><span class="o">=</span><span class="n">parse_miso</span><span class="p">(</span><span class="n">pth</span><span class="p">,</span> <span class="n">dclen</span><span class="p">,</span> <span class="n">case_i</span><span class="p">)</span>
            <span class="c1">#import pdb; pdb.set_trace()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">meas</span><span class="o">=</span><span class="n">parse_miso</span><span class="p">(</span><span class="n">pth</span><span class="p">,</span> <span class="n">dclen</span><span class="p">)</span>
        <span class="n">dsec</span><span class="p">[</span><span class="s2">&quot;meas_lab&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">meas</span><span class="p">[</span><span class="s2">&quot;lab&quot;</span><span class="p">]</span>
        <span class="n">dsec</span><span class="p">[</span><span class="s2">&quot;meas_ms&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">meas</span><span class="p">[</span><span class="s2">&quot;ms&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">case_i</span><span class="p">:</span>
            <span class="n">df_kin</span><span class="o">=</span><span class="n">pa</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span> <span class="c1"># return empty data frame for kinetic measurements</span>
    <span class="c1"># simple sections</span>
    <span class="k">if</span> <span class="s2">&quot;linp&quot;</span> <span class="ow">in</span> <span class="n">mtf</span> <span class="ow">and</span> <span class="n">mtf</span><span class="p">[</span><span class="s2">&quot;linp&quot;</span><span class="p">]:</span>
        <span class="n">pth</span><span class="o">=</span><span class="n">try_ext</span><span class="p">(</span><span class="n">mtf</span><span class="p">[</span><span class="s2">&quot;linp&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;linp&quot;</span><span class="p">,</span> <span class="s2">&quot;tsv&quot;</span><span class="p">,</span> <span class="s2">&quot;txt&quot;</span><span class="p">])</span>
        <span class="n">dsec</span><span class="p">[</span><span class="s2">&quot;linp&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">parse_linp</span><span class="p">(</span><span class="n">pth</span><span class="p">,</span> <span class="n">dclen</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;mflux&quot;</span> <span class="ow">in</span> <span class="n">mtf</span> <span class="ow">and</span> <span class="n">mtf</span><span class="p">[</span><span class="s2">&quot;mflux&quot;</span><span class="p">]:</span>
        <span class="n">pth</span><span class="o">=</span><span class="n">try_ext</span><span class="p">(</span><span class="n">mtf</span><span class="p">[</span><span class="s2">&quot;mflux&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;mflux&quot;</span><span class="p">,</span> <span class="s2">&quot;tsv&quot;</span><span class="p">,</span> <span class="s2">&quot;txt&quot;</span><span class="p">])</span>
        <span class="n">dsec</span><span class="p">[</span><span class="s2">&quot;mflux&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">parse_mflux</span><span class="p">(</span><span class="n">pth</span><span class="p">,</span> <span class="n">sfl</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;mmet&quot;</span> <span class="ow">in</span> <span class="n">mtf</span> <span class="ow">and</span> <span class="n">mtf</span><span class="p">[</span><span class="s2">&quot;mmet&quot;</span><span class="p">]:</span>
        <span class="n">pth</span><span class="o">=</span><span class="n">try_ext</span><span class="p">(</span><span class="n">mtf</span><span class="p">[</span><span class="s2">&quot;mmet&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;mmet&quot;</span><span class="p">,</span> <span class="s2">&quot;tsv&quot;</span><span class="p">,</span> <span class="s2">&quot;txt&quot;</span><span class="p">])</span>
        <span class="n">dsec</span><span class="p">[</span><span class="s2">&quot;mmet&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">parse_mmet</span><span class="p">(</span><span class="n">pth</span><span class="p">,</span> <span class="n">itnal_met</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;opt&quot;</span> <span class="ow">in</span> <span class="n">mtf</span> <span class="ow">and</span> <span class="n">mtf</span><span class="p">[</span><span class="s2">&quot;opt&quot;</span><span class="p">]:</span>
        <span class="n">pth</span><span class="o">=</span><span class="n">try_ext</span><span class="p">(</span><span class="n">mtf</span><span class="p">[</span><span class="s2">&quot;opt&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;opt&quot;</span><span class="p">,</span> <span class="s2">&quot;tsv&quot;</span><span class="p">,</span> <span class="s2">&quot;txt&quot;</span><span class="p">])</span>
        <span class="n">dsec</span><span class="p">[</span><span class="s2">&quot;opt&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">parse_opt</span><span class="p">(</span><span class="n">pth</span><span class="p">)</span>
    <span class="c1"># with subsections NET/XCH/...</span>
    <span class="k">if</span> <span class="s2">&quot;tvar&quot;</span> <span class="ow">in</span> <span class="n">mtf</span> <span class="ow">and</span> <span class="n">mtf</span><span class="p">[</span><span class="s2">&quot;tvar&quot;</span><span class="p">]:</span>
        <span class="n">pth</span><span class="o">=</span><span class="n">try_ext</span><span class="p">(</span><span class="n">mtf</span><span class="p">[</span><span class="s2">&quot;tvar&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;tvar&quot;</span><span class="p">,</span> <span class="s2">&quot;tsv&quot;</span><span class="p">,</span> <span class="s2">&quot;txt&quot;</span><span class="p">])</span>
        <span class="n">tf</span><span class="p">,</span><span class="n">tm</span><span class="o">=</span><span class="n">parse_tvar</span><span class="p">(</span><span class="n">pth</span><span class="p">)</span>
        <span class="n">stvar</span><span class="o">=</span><span class="nb">dict</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">li</span><span class="p">))</span> <span class="k">for</span> <span class="n">nx</span><span class="p">,</span><span class="n">li</span> <span class="ow">in</span> <span class="n">tf</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="k">if</span> <span class="s2">&quot;NET&quot;</span> <span class="ow">in</span> <span class="n">tf</span><span class="p">:</span>
            <span class="n">dsec</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;NET&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tf</span><span class="p">[</span><span class="s2">&quot;NET&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;XCH&quot;</span> <span class="ow">in</span> <span class="n">tf</span><span class="p">:</span>
            <span class="n">dsec</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;XCH&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tf</span><span class="p">[</span><span class="s2">&quot;XCH&quot;</span><span class="p">]</span>
        <span class="n">dsec</span><span class="p">[</span><span class="s2">&quot;met_pool&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tm</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">stvar</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;NET&quot;</span><span class="p">:</span> <span class="nb">set</span><span class="p">(),</span> <span class="s2">&quot;XCH&quot;</span><span class="p">:</span> <span class="nb">set</span><span class="p">()}</span>
        <span class="n">dsec</span><span class="p">[</span><span class="s2">&quot;met_pool&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">+</span><span class="n">m</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">0.1&quot;</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">itnal_met</span><span class="p">]</span>

    <span class="n">snrev</span><span class="o">=</span><span class="nb">set</span><span class="p">()</span> <span class="c1"># set of non reversible fluxes</span>
    <span class="k">for</span> <span class="n">tpl</span> <span class="ow">in</span> <span class="n">fluxes</span><span class="p">:</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">rev</span><span class="p">,</span> <span class="n">imposed_sens</span><span class="p">,</span> <span class="n">fd</span><span class="o">=</span><span class="n">tpl</span>
        <span class="c1">#if f == &quot;R_FORt&quot;:</span>
        <span class="c1">#    import pdb; pdb.set_trace()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rev</span><span class="p">:</span>
            <span class="n">dsec</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;XCH&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="si">%s</span><span class="se">\t</span><span class="s2">C</span><span class="se">\t</span><span class="s2">0&quot;</span><span class="o">%</span><span class="n">f</span><span class="p">]</span>
            <span class="n">snrev</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="s2">&quot;tvar&quot;</span> <span class="ow">in</span> <span class="n">mtf</span><span class="p">:</span>
            <span class="n">dsec</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;XCH&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="si">%s</span><span class="se">\t</span><span class="s2">F</span><span class="se">\t</span><span class="s2">0.01&quot;</span><span class="o">%</span><span class="n">f</span><span class="p">]</span>
    <span class="n">badf</span><span class="o">=</span><span class="n">stvar</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XCH&quot;</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span> <span class="o">&amp;</span> <span class="n">snrev</span>
    <span class="k">if</span> <span class="n">badf</span><span class="p">:</span>
        <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;following fluxes should not appear in &#39;</span><span class="si">%s</span><span class="s2">&#39;, with &#39;XCH&#39; kind as they are non reversible in &#39;</span><span class="si">%s</span><span class="s2">&#39;:</span><span class="se">\n\t</span><span class="s2">&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">mtf</span><span class="p">[</span><span class="s2">&quot;tvar&quot;</span><span class="p">],</span> <span class="n">mtf</span><span class="p">[</span><span class="s2">&quot;netw&quot;</span><span class="p">],</span> <span class="s2">&quot;&#39;</span><span class="se">\n\t</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">badf</span><span class="p">)))</span>
    <span class="c1"># f, rev, imposed_sens, fd=tpl</span>
    <span class="n">dtnet</span><span class="o">=</span><span class="nb">dict</span><span class="p">((</span><span class="n">tpl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;</span><span class="se">\t\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="s2">0.2E0&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">tpl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;F&quot;</span> <span class="k">if</span> <span class="n">tpl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">ff</span> <span class="k">else</span> <span class="s2">&quot;D&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">tpl</span> <span class="ow">in</span> <span class="n">fluxes</span><span class="p">)</span>
    <span class="n">dtxch</span><span class="o">=</span><span class="nb">dict</span><span class="p">((</span><span class="n">tpl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;</span><span class="se">\t\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">tpl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="se">\t</span><span class="s2">0.01E0&quot;</span><span class="o">%</span><span class="n">tpl</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> <span class="k">for</span> <span class="n">tpl</span> <span class="ow">in</span> <span class="n">fluxes</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">tpl</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="c1"># fluxes that are not in tvar are completed from dtnet and dtxch</span>
    <span class="n">dsec</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;NET&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">dtnet</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stvar</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;NET&quot;</span><span class="p">,</span> <span class="nb">set</span><span class="p">())]</span>
    <span class="n">dsec</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;XCH&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">dtxch</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">stvar</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XCH&quot;</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span> <span class="o">|</span> <span class="n">snrev</span><span class="p">)]</span>
    <span class="c1">#import pdb; pdb.set_trace()</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">dsec</span><span class="p">,</span> <span class="n">dclen</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">case_i</span> <span class="k">else</span> <span class="p">(</span><span class="n">dsec</span><span class="p">,</span> <span class="n">dclen</span><span class="p">,</span> <span class="n">df_kin</span><span class="p">)</span></div>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">argv</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">res_ftbl</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">ord_args</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">class</span> <span class="nc">ordAction</span><span class="p">(</span><span class="n">argparse</span><span class="o">.</span><span class="n">Action</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">option_string</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">ord_args</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">,</span> <span class="n">values</span><span class="p">))</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="vm">__doc__</span><span class="p">,</span> <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">RawTextHelpFormatter</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--mtf&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">ordAction</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span>
<span class="sd">&quot;&quot;&quot;MTF is a coma separated list of files with following extensions/meanings:</span>
<span class="sd"> netw: a text file with stoichiometric reactions and label transitions (one per line)</span>
<span class="sd">    Comments starts with &#39;#&#39; but those starting with &#39;###&#39; introduce </span>
<span class="sd">    pathways which are numbered as well as reactions in them. Reaction </span>
<span class="sd">    name can precede the reaction itself and is separated by &quot;:&quot; If no </span>
<span class="sd">    explicit name is given, reactions in FTBL file will be named </span>
<span class="sd">    according a pattern &#39;rX.Y&#39; where X is pathway number and Y is </span>
<span class="sd">    reaction number in the pathway. But it is highly recommended to </span>
<span class="sd">    give explicit names to reactions.</span>
<span class="sd">    Symbols &quot;+&quot;, &quot;(&quot;, &quot;)&quot; and &quot;:&quot; are not allowed in metabolite neither reaction names</span>
<span class="sd">    Example of reaction and label transition:</span>
<span class="sd">       edd: Gnt6P (ABCDEF) -&gt; Pyr (ABC) + GA3P (DEF)</span>
<span class="sd">    Non reversible reactions are signaled with &#39;-&gt;&#39; (as in the example above).</span>
<span class="sd">    A sign &#39;&lt;-&gt;&#39; can be used for reversible reactions.</span>
<span class="sd">    If &#39;netw&#39; name is equal to &#39;-&#39;, then its content is read from standard input, e.g.</span>
<span class="sd">      &#39;--mtf netw=-&#39;</span>
<span class="sd"> linp: label inputs (starting from this extensions, TSV files are assumed)</span>
<span class="sd"> miso: isotopic measurements (NMR (label, peak) and MS)</span>
<span class="sd"> mflux: flux measurements</span>
<span class="sd"> mmet: metabolite concentration measurements</span>
<span class="sd"> tvar: type of variables (NET or XCH , free or dependent, starting values, ...)</span>
<span class="sd"> cnstr: equality and inequality constraints on fluxes and concentrations</span>
<span class="sd"> opt: options</span>
<span class="sd"> ftbl: name of output FTBL file. If not given, it will be equal to &#39;netw&#39;</span>
<span class="sd">   stem with &#39;.ftbl&#39; extension. If it is equal to &#39;-&#39;, then the result </span>
<span class="sd">   will be written to standard output, e.g.</span>
<span class="sd">     &#39;txt2ftbl --mtf ftbl=-,ecoli.netw&#39;</span>
<span class="sd">   Intermediate directories in ftbl path are silently created if non existent.</span>
<span class="sd"> vmtf: variable part of mtf approach.</span>
<span class="sd">   If a series of FTBL files has to be generated partially with </span>
<span class="sd">   information common to all files (constant part) and partially with </span>
<span class="sd">   sections proper to each FTBL (variable part) then files containing </span>
<span class="sd">   variable sections (e.g. &#39;miso&#39;) can be given in a special file </span>
<span class="sd">   having an extension (or prefix, cf. hereafter) &#39;vmtf&#39;. In such a </span>
<span class="sd">   way, each FTBL file will be produced from combination of MTF files </span>
<span class="sd">   given directly in this option (constant part) and files given on a </span>
<span class="sd">   corresponding row of &#39;vmtf&#39; file. vmtf file is a TSV file with </span>
<span class="sd">   columns using the same names: &#39;netw&#39;, &#39;linp&#39;, etc. Each row contains </span>
<span class="sd">   file names that will be used to produce an FTBL file. Thus each row </span>
<span class="sd">   must have &#39;ftbl&#39; column with unique and non empty name. When &#39;vmtf&#39; </span>
<span class="sd">   is used, &#39;ftbl&#39; cannot be present on the command line. If a file </span>
<span class="sd">   type is present both in column names of &#39;vmtf&#39; and in &#39;--mtf&#39; option </span>
<span class="sd">   then the content of &#39;vmtf&#39; file will take precedence. Empty values </span>
<span class="sd">   in &#39;vmtf&#39; file are ignored. All file paths in &#39;vmtf&#39; file are </span>
<span class="sd">   considered relative to the location of &#39;vmtf&#39; file itself.</span>
<span class="sd">Only first 3 files are necessary to obtain a workable FTBL file, others </span>
<span class="sd">are optional.</span>
<span class="sd">Example: &#39;txt2ftbl --mtf ecoli.netw,glu08C1_02U.linp,cond1.miso,cond1.mflux&#39;</span>
<span class="sd">NB: no space is allowed around comas. If a file path has a spaces in </span>
<span class="sd">its name, it must be enclosed into quotes or double quotes.</span>
<span class="sd">If an entry file cannot be renamed to have some of these extensions, then</span>
<span class="sd">they can be used as prefixes followed by a &#39;=&#39; sign, e.g.</span>
<span class="sd">  &#39;txt2ftbl --mtf netw=ecoli.txt,linp=glu08C1_02U.tsv,cond1.miso,cond1.mflux&#39;</span>
<span class="sd">As you can see from this example, both naming schemes can be mixed.</span>
<span class="sd">If for some reason, the same type of file is indicated several times</span>
<span class="sd">(no matter with extension or prefix), the last occurrence supersedes</span>
<span class="sd">all precedent ones.</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--prefix&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">ordAction</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span>
<span class="sd">&quot;&quot;&quot;If all input files have the same name pattern and are different only </span>
<span class="sd">in extensions then the pattern can be given as PREFIX, e.g.</span>
<span class="sd">  &#39;--prefix somedir/ecoli&#39;</span>
<span class="sd">Then in &#39;somedir&#39;, we suppose to have &#39;ecoli.netw&#39;, &#39;ecoli.linp&#39; and </span>
<span class="sd">other input files having names starting with &#39;ecoli&#39; and ending with </span>
<span class="sd">corresponding extensions.</span>
<span class="sd">NB. If some file is given in more than one option: &#39;--prefix&#39; and/or </span>
<span class="sd">&#39;--mtf&#39; then the last occurrence overrides precedent ones.</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--eprl&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;append&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span>
<span class="sd">&quot;&quot;&quot;Parallel experiments can be given with this option. It must</span>
<span class="sd">introduce a couple of linp/miso files and optional auxiliary ftbl name. These files</span>
<span class="sd">correspond to a given parallel experiment. This option can be repeated as</span>
<span class="sd">many times as there are additional parallel experiments, e.g.</span>
<span class="sd">  &#39;txt2ftbl --mtf ec.netw,glc6.linp,glc6.miso --eprl glc1.linp,glc1.miso --eprl glc4.linp,glc4.miso&#39;</span>
<span class="sd">This command will produce a main FTBL file &#39;ec.ftbl&#39; including all necessary</span>
<span class="sd">sections (NETWORK, etc.) but also two auxiliary FTBL files: &#39;glc1.ftbl&#39; and</span>
<span class="sd">&#39;glc4.ftbl&#39; having only label input/measurement sections. They will correspond</span>
<span class="sd">to 2 additional parallel experiments. If ftbl file is not given in --eprl</span>
<span class="sd">option, the name of miso file will be used for it. If intermediate</span>
<span class="sd">directories in ftbl path are non existent they will be silently created.</span>
<span class="sd">Auxiliary ftbl names will be put in &#39;OPTIONS/prl_exp&#39; field on the main ftbl file.</span>
<span class="sd">These names will be written there in a form relative to the main ftbl.</span>
<span class="sd">To shorten the writings, it is possible to indicate only one of two .miso/.linp files.</span>
<span class="sd">The other one will be guessed if it has canonical extension. If extension is omitted then .miso and .linp files are searched with these extensions. In this case, several parallel experiments can be given with one --eprl option. So that above example can be shorten to:</span>
<span class="sd">  &#39;txt2ftbl --mtf ec.netw,glc6.linp,glc6.miso --eprl glc1,glc4&#39;</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--inst&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span>
<span class="sd">&quot;&quot;&quot;Prepare FTBL for instationary case. File &#39;netw&#39; is supposed to have </span>
<span class="sd">column &#39;Time&#39; non empty. Isotopic kinetic data will be written to a TSV </span>
<span class="sd">file with &#39;ikin&#39; extension. Its name will be the same as in FTBL file, </span>
<span class="sd">and FTBL field &#39;OPTIONS/file_labcin&#39; will contain &#39;ikin&#39; file name.</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--force&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span>
<span class="sd">&quot;&quot;&quot;Overwrite an existent result file not produced by this script.</span>
<span class="sd">NB. If a result file exists and is actually produced by this script, </span>
<span class="sd">then it is silently overwritten even without this option. The script </span>
<span class="sd">detects if it was the creator of a file by searching for a string &quot;// </span>
<span class="sd">Created by &#39;txt2ftbl&quot; at the first line of the file. By removing or </span>
<span class="sd">editing this comment, user can protect a file from a silent </span>
<span class="sd">overwriting.</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;netw&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">If &#39;netw&#39; file is not given in any option (neither --mtf nor --prefix), it </span>
<span class="s2">can be given as the only argument NETW, e.g.</span>
<span class="s2">  txt2ftbl ecoli.txt</span>
<span class="s2">or</span>
<span class="s2">  txt2ftbl --mtf ms_nmr_data.miso,glucose.linp ecoli.txt</span>
<span class="s2">If &#39;netw&#39; file name is given both in any option and as an argument, it </span>
<span class="s2">is the argument value that will take precedence.</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">print_usage</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="c1">#print(&quot;opts=&quot;, vars(opts))</span>
    <span class="c1">#print(&quot;ord=&quot;, ord_args)</span>
    <span class="c1"># default values</span>
    <span class="n">mtfsuf</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;netw&quot;</span><span class="p">,</span> <span class="s2">&quot;linp&quot;</span><span class="p">,</span> <span class="s2">&quot;miso&quot;</span><span class="p">,</span> <span class="s2">&quot;mflux&quot;</span><span class="p">,</span> <span class="s2">&quot;mmet&quot;</span><span class="p">,</span> <span class="s2">&quot;tvar&quot;</span><span class="p">,</span> <span class="s2">&quot;cnstr&quot;</span><span class="p">,</span> <span class="s2">&quot;opt&quot;</span><span class="p">,</span> <span class="s2">&quot;vmtf&quot;</span><span class="p">,</span> <span class="s2">&quot;ftbl&quot;</span><span class="p">}</span>
    <span class="n">mtf</span><span class="o">=</span><span class="p">{}</span> <span class="c1"># multiplex tsv files to compile</span>
    <span class="n">prl</span><span class="o">=</span><span class="p">[]</span> <span class="c1"># parallel experiments, 2 or 3-tuples linp+miso(+ftbl)</span>
    <span class="c1"># get arguments</span>
    <span class="n">opts</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span>
    <span class="n">force</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">force</span>
    <span class="n">netw</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">netw</span>
    <span class="n">case_i</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">inst</span>
    <span class="k">for</span> <span class="n">o</span><span class="p">,</span><span class="n">a</span> <span class="ow">in</span> <span class="n">ord_args</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">o</span> <span class="o">==</span> <span class="s2">&quot;mtf&quot;</span><span class="p">:</span>
            <span class="c1"># make dict {&quot;miso&quot;: &lt;file_path&gt;, &quot;netw&quot;: ...}</span>
            <span class="c1"># a is like &quot;f.netw,exp1.miso,....&quot;</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
                <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="s2">&quot;=&quot;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                    <span class="n">ty</span><span class="p">,</span><span class="n">nm</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">mtf</span><span class="p">[</span><span class="n">ty</span><span class="p">]</span><span class="o">=</span><span class="n">nm</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mtf</span><span class="p">[</span><span class="n">Path</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span><span class="o">=</span><span class="n">v</span>
        <span class="k">elif</span> <span class="n">o</span> <span class="o">==</span> <span class="s2">&quot;prefix&quot;</span><span class="p">:</span>
            <span class="c1"># a is like &quot;/some/path/file_stem&quot;</span>
            <span class="n">f</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                <span class="n">d</span><span class="o">=</span><span class="n">f</span>
                <span class="n">stem</span><span class="o">=</span><span class="s2">&quot;*&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">d</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">parent</span>
                <span class="n">stem</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">d</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;directory &#39;</span><span class="si">%s</span><span class="s2">&#39; from --prefix does not exist&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
            <span class="n">nfound</span><span class="o">=</span><span class="mi">0</span>
            <span class="c1">#print(&quot;d=&quot;, d, &quot;\tstem=&quot;, stem)</span>
            <span class="k">for</span> <span class="n">suf</span> <span class="ow">in</span> <span class="n">mtfsuf</span><span class="o">-</span><span class="p">{</span><span class="s2">&quot;ftbl&quot;</span><span class="p">}:</span>
                <span class="n">li</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">stem</span><span class="o">+</span><span class="s2">&quot;.&quot;</span><span class="o">+</span><span class="n">suf</span><span class="p">))</span>
                <span class="c1">#print(&quot;suf=&quot;, suf, &quot;\tli=&quot;, li)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">li</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;multiple .</span><span class="si">%s</span><span class="s2"> files found:</span><span class="se">\n\t</span><span class="s2">&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">suf</span><span class="p">,</span> <span class="s2">&quot;&#39;</span><span class="se">\n\t</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">li</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">li</span><span class="p">:</span>
                    <span class="n">mtf</span><span class="p">[</span><span class="n">suf</span><span class="p">]</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">li</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">nfound</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">nfound</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;No MTF file found with prefix &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="o">%</span><span class="n">a</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;vmtf&quot;</span> <span class="ow">in</span> <span class="n">mtf</span> <span class="ow">and</span> <span class="s2">&quot;ftbl&quot;</span> <span class="ow">in</span> <span class="n">mtf</span><span class="p">:</span>
        <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;&#39;ftbl&#39; and &#39;vmtf&#39; cannot be simultaneously present in &#39;--mtf&#39; option&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">netw</span><span class="p">:</span>
        <span class="n">mtf</span><span class="p">[</span><span class="s2">&quot;netw&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">netw</span> <span class="c1"># overwrite previous setting if any</span>
    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">eprl</span> <span class="ow">and</span> <span class="s2">&quot;vmtf&quot;</span> <span class="ow">in</span> <span class="n">mtf</span><span class="p">:</span>
        <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;Option --eprl cannot be used simultaneously with &#39;vmtf&#39; entry in --mtf&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">eprl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">eprl</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">if</span> <span class="s2">&quot;netw&quot;</span> <span class="ow">in</span> <span class="n">mtf</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mtf</span><span class="p">[</span><span class="s2">&quot;netw&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
            <span class="n">mtf</span><span class="p">[</span><span class="s2">&quot;netw&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mtf</span><span class="p">[</span><span class="s2">&quot;netw&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">mtf</span><span class="p">[</span><span class="s2">&quot;netw&quot;</span><span class="p">])</span>
    <span class="c1"># what kind of output we have?</span>
    <span class="k">if</span> <span class="s2">&quot;ftbl&quot;</span> <span class="ow">in</span> <span class="n">mtf</span><span class="p">:</span>
        <span class="n">p</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">mtf</span><span class="p">[</span><span class="s2">&quot;ftbl&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;.ftbl&quot;</span><span class="p">:</span>
            <span class="n">mtf</span><span class="p">[</span><span class="s2">&quot;ftbl&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">p</span>
        <span class="k">elif</span> <span class="n">mtf</span><span class="p">[</span><span class="s2">&quot;ftbl&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
            <span class="n">mtf</span><span class="p">[</span><span class="s2">&quot;ftbl&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mtf</span><span class="p">[</span><span class="s2">&quot;ftbl&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">parent</span><span class="o">/</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;.ftbl&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s2">&quot;netw&quot;</span> <span class="ow">in</span> <span class="n">mtf</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s2">&quot;vmtf&quot;</span> <span class="ow">in</span> <span class="n">mtf</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mtf</span><span class="p">[</span><span class="s2">&quot;netw&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">:</span>
            <span class="n">mtf</span><span class="p">[</span><span class="s2">&quot;ftbl&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mtf</span><span class="p">[</span><span class="s2">&quot;ftbl&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">mtf</span><span class="p">[</span><span class="s2">&quot;netw&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.ftbl&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="s2">&quot;vmtf&quot;</span> <span class="ow">in</span> <span class="n">mtf</span><span class="p">:</span>
        <span class="n">mtf</span><span class="p">[</span><span class="s2">&quot;ftbl&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
    <span class="c1"># get opt in preamble</span>
    <span class="k">if</span> <span class="s2">&quot;opt&quot;</span> <span class="ow">in</span> <span class="n">mtf</span><span class="p">:</span>
        <span class="n">dfopt</span><span class="o">=</span><span class="n">tsv2df</span><span class="p">(</span><span class="n">mtf</span><span class="p">[</span><span class="s2">&quot;opt&quot;</span><span class="p">])</span>
    <span class="c1"># prepare prl</span>
    <span class="c1"># if no --eprl, get prl_exp from .opt</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">opts</span><span class="o">.</span><span class="n">eprl</span> <span class="ow">and</span> <span class="s2">&quot;opt&quot;</span> <span class="ow">in</span> <span class="n">mtf</span><span class="p">:</span>
        <span class="n">wd</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">mtf</span><span class="p">[</span><span class="s2">&quot;opt&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">parent</span>
        <span class="n">fli</span><span class="o">=</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dfopt</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dfopt</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;prl_exp&quot;</span><span class="p">,</span> <span class="s2">&quot;Value&quot;</span><span class="p">]]</span>
        <span class="c1">#print(&quot;fli=&quot;, fli)</span>
        <span class="n">fli</span><span class="o">=</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">wd</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fli</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
        <span class="c1">#print(&quot;fli2=&quot;, fli)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fli</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">eprl</span>
    <span class="c1">#import pdb; pdb.set_trace()</span>
    
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">fli</span><span class="p">:</span> <span class="c1"># prepare prl list</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
            <span class="n">d</span><span class="o">=</span><span class="p">{}</span>
            <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s2">&quot;=&quot;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                <span class="n">ty</span><span class="p">,</span><span class="n">nm</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ty</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">nm</span><span class="o">=</span><span class="n">v</span>
            <span class="k">if</span> <span class="n">ty</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;linp&quot;</span><span class="p">,</span> <span class="s2">&quot;miso&quot;</span><span class="p">,</span> <span class="s2">&quot;opt&quot;</span><span class="p">,</span> <span class="s2">&quot;ftbl&quot;</span><span class="p">):</span>
                <span class="n">nm</span><span class="o">=</span><span class="n">try_ext</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;miso&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">nm</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                    <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;option --eprl expects in argument a list of linp, miso and optionally auxiliary ftbl files instead got type &#39;</span><span class="si">%s</span><span class="s2">&#39; in &#39;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ty</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>
                <span class="n">ty</span><span class="o">=</span><span class="s2">&quot;miso&quot;</span>
            <span class="n">d</span><span class="p">[</span><span class="n">ty</span><span class="p">]</span><span class="o">=</span><span class="n">nm</span>
            <span class="k">if</span> <span class="s2">&quot;linp&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                <span class="n">p</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;miso&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.linp&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;linp&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">p</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;&#39;linp&#39; file was not found for --eprl option &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="o">%</span><span class="n">t</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;miso&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                <span class="n">p</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;linp&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.miso&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;miso&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">p</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;&#39;miso&#39; file was not found for --eprl option &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="o">%</span><span class="n">t</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;opt&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                <span class="n">p</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;miso&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.opt&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;opt&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">p</span>
            <span class="k">if</span> <span class="s2">&quot;ftbl&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="s2">&quot;ftbl&quot;</span><span class="p">]</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;miso&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.ftbl&quot;</span><span class="p">))</span>
            <span class="n">d</span><span class="p">[</span><span class="s2">&quot;ftbl&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;ftbl&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.ftbl&quot;</span><span class="p">)</span>
            <span class="n">prl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="c1">#print(&quot;prl=&quot;, prl)</span>

    <span class="n">cmd</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">me</span><span class="si">}</span><span class="s2"> &quot;</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\ &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">argv</span><span class="p">)</span>
    <span class="n">scre</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;// Created by &#39;</span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="o">+</span><span class="s2">&quot; at </span><span class="si">%s</span><span class="s2">.</span><span class="se">\n</span><span class="s2">// If edited by hand, remove these comments.</span><span class="se">\n</span><span class="s2">&quot;</span>
    
    <span class="k">if</span> <span class="s2">&quot;vmtf&quot;</span> <span class="ow">in</span> <span class="n">mtf</span><span class="p">:</span>
        <span class="n">vdf</span><span class="o">=</span><span class="n">tsv2df</span><span class="p">(</span><span class="n">mtf</span><span class="p">[</span><span class="s2">&quot;vmtf&quot;</span><span class="p">])</span>
        <span class="n">dftbl</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">mtf</span><span class="p">[</span><span class="s2">&quot;vmtf&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">parent</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vdf</span><span class="o">=</span><span class="n">pa</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;ftbl&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">mtf</span><span class="p">[</span><span class="s2">&quot;ftbl&quot;</span><span class="p">]],</span> <span class="s2">&quot;iline&quot;</span><span class="p">:[</span><span class="s2">&quot;NA&quot;</span><span class="p">]})</span>
        <span class="n">dftbl</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">del</span><span class="p">(</span><span class="n">mtf</span><span class="p">[</span><span class="s2">&quot;ftbl&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="s2">&quot;ftbl&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vdf</span><span class="p">:</span>
        <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;&#39;ftbl&#39; column must be present in &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="o">%</span><span class="n">mtf</span><span class="p">[</span><span class="s2">&quot;vmtf&quot;</span><span class="p">])</span>
    <span class="c1"># check case_i in opt</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">case_i</span> <span class="ow">and</span> <span class="s2">&quot;opt&quot;</span> <span class="ow">in</span> <span class="n">mtf</span><span class="p">:</span>
        <span class="n">tmp</span><span class="o">=</span><span class="n">dfopt</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dfopt</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;file_labcin&quot;</span><span class="p">,</span> <span class="s2">&quot;Value&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;instationary mode is activated as &#39;file_labcin&#39; is not empty in &#39;</span><span class="si">{</span><span class="n">mtf</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="n">case_i</span><span class="o">=</span><span class="kc">True</span>
    <span class="c1"># run through all ftbls</span>
    <span class="k">if</span> <span class="n">dftbl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># add dftbl to all fields in vmtf</span>
        <span class="n">vdf</span><span class="p">[</span><span class="n">vdf</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">dftbl</span><span class="o">/</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vdf</span><span class="p">[</span><span class="n">vdf</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">v</span><span class="p">]</span>
        
    <span class="k">for</span> <span class="n">ftbl</span><span class="p">,</span><span class="n">ligr</span> <span class="ow">in</span> <span class="n">vdf</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;ftbl&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">il</span><span class="o">=</span><span class="n">vdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ligr</span><span class="p">,</span> <span class="s2">&quot;iline&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="c1"># strings</span>
        <span class="c1"># sanity check</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ligr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">werr</span><span class="p">(</span><span class="s2">&quot;&#39;ftbl&#39; column has repeated values in &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">mtf</span><span class="p">[</span><span class="s2">&quot;vmtf&quot;</span><span class="p">],</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">il</span><span class="p">)))</span>
        <span class="c1"># prepare running mtf, full mtf for one row</span>
        <span class="n">rmtf</span><span class="o">=</span><span class="n">mtf</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">rmtf</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">vdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ligr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span><span class="p">)</span>

        <span class="c1"># what kind of output we have?</span>
        <span class="k">if</span> <span class="n">ftbl</span> <span class="o">!=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>
            <span class="n">p</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">ftbl</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;.ftbl&quot;</span><span class="p">:</span>
                <span class="n">ftbl</span><span class="o">=</span><span class="n">p</span>
            <span class="k">elif</span> <span class="n">ftbl</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                <span class="n">ftbl</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ftbl</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">parent</span><span class="o">/</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;.ftbl&quot;</span><span class="p">)</span>
        <span class="c1"># check if we can overwrite</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span> <span class="ow">and</span> <span class="n">ftbl</span> <span class="o">!=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ftbl</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="ow">and</span> <span class="n">ftbl</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">ftbl</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fc</span><span class="p">:</span>
                     <span class="k">if</span> <span class="n">scre</span><span class="p">[:</span><span class="mi">23</span><span class="p">]</span> <span class="o">!=</span> <span class="n">fc</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">23</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">():</span>
                         <span class="n">werr</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cannot overwrite &#39;</span><span class="si">{</span><span class="n">fc</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; as not created by this script. Use &#39;--force&#39; to go through.&quot;</span><span class="p">)</span>
        <span class="n">ftbl</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># compile ftbl dict &#39;dsec&#39;</span>
        <span class="c1"># make prl relative to main ftbl</span>
        <span class="k">if</span> <span class="n">ftbl</span> <span class="o">==</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>
            <span class="n">wd</span><span class="o">=</span><span class="n">Path</span><span class="p">()</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wd</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">ftbl</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parent</span>
        <span class="k">if</span> <span class="n">case_i</span><span class="p">:</span>
            <span class="c1">#import pdb; pdb.set_trace()</span>
            <span class="n">dsec</span><span class="p">,</span><span class="n">dclen</span><span class="p">,</span><span class="n">df_kin</span><span class="o">=</span><span class="nb">compile</span><span class="p">(</span><span class="n">rmtf</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">case_i</span><span class="p">)</span>
            <span class="n">p</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">ftbl</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
            <span class="n">p</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">p</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fc</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">scre</span><span class="p">[:</span><span class="mi">23</span><span class="p">]</span> <span class="o">!=</span> <span class="n">fc</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">23</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">():</span>
                         <span class="n">werr</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cannot overwrite &#39;</span><span class="si">{</span><span class="n">fc</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; as not created by this script. Use &#39;--force&#39; to go through.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_kin</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">fkin</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.ikin&quot;</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">fkin</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fc</span><span class="p">:</span>
                    <span class="n">fc</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">scre</span><span class="o">%</span><span class="n">dtstamp</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;row_col&quot;</span><span class="p">)</span>
                    <span class="c1">#import pdb; pdb.set_trace()</span>
                    <span class="c1">#df_kin.reindex(index=sorted(df_kin.index, key=natural_sort_key))</span>
                    <span class="n">df_kin</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">sorted</span><span class="p">(</span><span class="n">df_kin</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">natural_sort_key</span><span class="p">),</span> <span class="p">:]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1">#print(str(fkin))</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dsec</span><span class="p">[</span><span class="s2">&quot;opt&quot;</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">file_labcin</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">):</span>
                        <span class="n">dsec</span><span class="p">[</span><span class="s2">&quot;opt&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">file_labcin</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">//file_labcin</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">dsec</span><span class="p">[</span><span class="s2">&quot;opt&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">file_labcin</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">fkin</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">parent</span><span class="p">)))</span>
            <span class="c1"># prl</span>
            <span class="n">prl_li</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">prl</span><span class="p">:</span>
                <span class="n">dsec_prl</span><span class="p">,</span><span class="n">dclen</span><span class="p">,</span><span class="n">df_kin_prl</span><span class="o">=</span><span class="nb">compile</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">case_i</span><span class="p">,</span> <span class="n">clen</span><span class="o">=</span><span class="n">dclen</span><span class="p">)</span>
                <span class="c1"># output ftbl</span>
                <span class="n">p</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;ftbl&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
                <span class="n">p</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">p</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fc</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">scre</span><span class="p">[:</span><span class="mi">23</span><span class="p">]</span> <span class="o">!=</span> <span class="n">fc</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">23</span><span class="p">):</span>
                            <span class="n">werr</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cannot overwrite &#39;</span><span class="si">{</span><span class="n">fc</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; as not created by this script. Use &#39;--force&#39; to go through.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_kin_prl</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">fkin</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.ikin&quot;</span><span class="p">)</span>
                    <span class="k">with</span> <span class="n">fkin</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fc</span><span class="p">:</span>
                        <span class="n">fc</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">scre</span><span class="o">%</span><span class="n">dtstamp</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;row_col&quot;</span><span class="p">)</span>
                        <span class="n">df_kin_prl</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">sorted</span><span class="p">(</span><span class="n">df_kin_prl</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">natural_sort_key</span><span class="p">),</span> <span class="p">:]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dsec_prl</span><span class="p">[</span><span class="s2">&quot;opt&quot;</span><span class="p">]):</span>
                        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">file_labcin</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">):</span>
                            <span class="n">dsec_prl</span><span class="p">[</span><span class="s2">&quot;opt&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">file_labcin</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">//file_labcin</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">out</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">scre</span><span class="o">%</span><span class="n">dtstamp</span><span class="p">())</span>
                    <span class="n">dsec_prl</span><span class="p">[</span><span class="s2">&quot;opt&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">file_labcin</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">fkin</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">parent</span><span class="p">)))</span>
                <span class="n">dsec2out</span><span class="p">(</span><span class="n">dsec_prl</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
                <span class="n">prl_li</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">wd</span><span class="p">)))</span>
                <span class="n">out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">prl_li</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dsec</span><span class="p">[</span><span class="s2">&quot;opt&quot;</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">prl_exp</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">):</span>
                        <span class="n">dsec</span><span class="p">[</span><span class="s2">&quot;opt&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">prl_exp</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">//prl_exp</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">dsec</span><span class="p">[</span><span class="s2">&quot;opt&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">prl_exp</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">+</span><span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prl_li</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dsec</span><span class="p">,</span><span class="n">dclen</span><span class="o">=</span><span class="nb">compile</span><span class="p">(</span><span class="n">rmtf</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
            <span class="c1"># prl</span>
            <span class="n">prl_li</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">prl</span><span class="p">:</span>
                <span class="n">dsec_prl</span><span class="p">,</span><span class="n">dclen</span><span class="o">=</span><span class="nb">compile</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">clen</span><span class="o">=</span><span class="n">dclen</span><span class="p">)</span>
                <span class="c1"># output ftbl</span>
                <span class="n">p</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;ftbl&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
                <span class="n">p</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">p</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fc</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">scre</span><span class="p">[:</span><span class="mi">23</span><span class="p">]</span> <span class="o">!=</span> <span class="n">fc</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">23</span><span class="p">):</span>
                             <span class="n">werr</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cannot overwrite &#39;</span><span class="si">{</span><span class="n">fc</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; as not created by this script. Use &#39;--force&#39; to go through.&quot;</span><span class="p">)</span>
                <span class="n">out</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span>
                <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">scre</span><span class="o">%</span><span class="n">dtstamp</span><span class="p">())</span>
                <span class="n">dsec2out</span><span class="p">(</span><span class="n">dsec_prl</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
                <span class="n">prl_li</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">wd</span><span class="p">)</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)))</span>
                <span class="n">out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">prl_li</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dsec</span><span class="p">[</span><span class="s2">&quot;opt&quot;</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">prl_exp</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">):</span>
                        <span class="n">dsec</span><span class="p">[</span><span class="s2">&quot;opt&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">prl_exp</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">//prl_exp</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">dsec</span><span class="p">[</span><span class="s2">&quot;opt&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">prl_exp</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">+</span><span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prl_li</span><span class="p">))</span>
        <span class="c1"># output ftbl</span>
        <span class="n">out</span><span class="o">=</span><span class="n">ftbl</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ftbl</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="n">Path</span><span class="p">())</span> <span class="k">else</span> <span class="n">ftbl</span>
        <span class="c1">#print((&quot;out=&quot;, out))</span>
        <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">scre</span><span class="o">%</span><span class="n">dtstamp</span><span class="p">())</span>
        <span class="n">dsec2out</span><span class="p">(</span><span class="n">dsec</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">case_i</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">ftbl</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="n">Path</span><span class="p">()):</span>
            <span class="kn">from</span> <span class="nn">ftbl2labcin</span> <span class="kn">import</span> <span class="n">main</span> <span class="k">as</span> <span class="n">renum</span>
            <span class="n">renum</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">ftbl</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">res_ftbl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">res_ftbl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span> <span class="ow">or</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;influx_si.cli&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">influx_si 6.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2012-2020, INRAE/INSA/CNRS.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.5.
    </div>
  </body>
</html>